<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReadingTurtle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 20px;
            padding: 15px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-main {
            flex: 1;
        }

        header h1 {
            font-size: 1.8rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .auth-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .auth-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .auth-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
        }

        .stats-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .stats-toggle-btn {
            display: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .stats-toggle-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .search-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-type-select {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .clear-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* Î†àÎ≤® ÌïÑÌÑ∞ */
        .level-filters {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .level-filter-group {
            flex: 1;
            min-width: 250px;
        }

        .filter-label {
            font-weight: bold;
            color: #333;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 8px;
        }

        .filter-reset-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .filter-reset-btn:hover {
            background: #e7e9ff;
        }

        /* ÎìÄÏñº Ïç∏ Î†àÏù∏ÏßÄ Ïä¨ÎùºÏù¥Îçî */
        .dual-range-container {
            position: relative;
            height: 40px;
            margin: 10px 0;
        }

        .range-slider {
            position: absolute;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            pointer-events: none;
            top: 50%;
            transform: translateY(-50%);
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            pointer-events: all;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
        }

        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #5568d3;
        }

        .range-slider::-moz-range-thumb {
            pointer-events: all;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .range-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            background: #5568d3;
        }

        .range-track {
            position: absolute;
            height: 6px;
            background: #e1e5e9;
            border-radius: 3px;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
        }

        .range-progress {
            position: absolute;
            height: 6px;
            background: #667eea;
            border-radius: 3px;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.1s ease;
        }

        .range-values {
            text-align: center;
            font-size: 0.85rem;
            color: #667eea;
            font-weight: bold;
            margin-top: 5px;
        }

        /* ÌïÑÌÑ∞ ÏòµÏÖò Î≤ÑÌäº Í∑∏Î£π */
        .filter-option-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
            font-weight: bold;
        }

        .filter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ÌïÑÌÑ∞ Í≤∞Í≥º Ïπ¥Ïö¥Ìä∏ */
        .filter-count {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: white;
            border-radius: 20px;
            border: 2px solid #667eea;
            color: #667eea;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .filter-count .count-number {
            color: #667eea;
            font-size: 1.1rem;
        }

        .dual-range-container {
            position: relative;
            padding: 10px 0;
        }

        .dual-range-slider {
            position: relative;
            height: 6px;
            background: #e1e5e9;
            border-radius: 3px;
            margin: 10px 0;
        }

        .dual-range-track {
            position: absolute;
            height: 100%;
            background: #667eea;
            border-radius: 3px;
        }

        .dual-range-inputs {
            position: relative;
        }

        .dual-range-inputs input {
            position: absolute;
            width: 100%;
            height: 6px;
            background: none;
            pointer-events: none;
            -webkit-appearance: none;
            margin: 0;
            top: 0;
        }

        .dual-range-inputs input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            pointer-events: all;
            z-index: 10;
            position: relative;
        }

        .dual-range-inputs input::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            pointer-events: all;
        }

        .results-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 1.5rem;
            color: #333;
        }

        .results-count {
            background: #e9ecef;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #666;
        }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .book-card {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .book-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .book-image-container {
            width: 100%;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .book-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .book-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            color: #6c757d;
            font-size: 3rem;
        }

        .book-isbn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        .book-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            line-height: 1.3;
        }

        .book-info {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 5px 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .book-info-label {
            font-weight: bold;
            color: #666;
        }

        .book-info-value {
            color: #333;
        }

        .ar-level {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            display: inline-block;
        }

        .quiz-available {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            display: inline-block;
        }

        .quiz-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            width: 100%;
        }

        .quiz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .quiz-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Îã®Ïñ¥ Î≥¥Í∏∞ Î≤ÑÌäº */
        .book-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .words-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s ease;
        }

        .words-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .words-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Ïä¨ÎùºÏù¥Îìú Ìå®ÎÑê Ïò§Î≤ÑÎ†àÏù¥ */
        .slide-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .slide-panel-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Ïä¨ÎùºÏù¥Îìú Ìå®ÎÑê */
        .slide-panel {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            max-width: 90vw;
            height: 100%;
            background: white;
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.2);
            z-index: 999;
            overflow-y: auto;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slide-panel.active {
            right: 0;
        }

        .slide-panel-header {
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .slide-panel-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slide-panel-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .slide-panel-subtitle {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .slide-panel-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-left: 15px;
        }

        .slide-panel-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .slide-panel-body {
            padding: 25px;
        }

        /* ÌÄ¥Ï¶à Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥ */
        .quiz-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .quiz-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        /* ÌÄ¥Ï¶à Î™®Îã¨ */
        .quiz-modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .quiz-modal-overlay.active .quiz-modal {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        .quiz-modal-header {
            padding: 30px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quiz-modal-title {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .quiz-modal-subtitle {
            margin: 8px 0 0 0;
            font-size: 0.95rem;
            opacity: 0.95;
        }

        .quiz-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-left: 20px;
        }

        .quiz-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .quiz-modal-body {
            padding: 30px;
            overflow-y: auto;
            max-height: calc(85vh - 120px);
        }

        .quizzes-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .words-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .word-item {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e1e5e9;
            transition: all 0.3s ease;
        }

        .word-item:hover {
            border-color: #667eea;
            background: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.15);
            transform: translateX(-5px);
        }

        .word-number {
            flex-shrink: 0;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .word-content {
            flex: 1;
        }

        .word-text {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .word-definition {
            color: #34495e;
            line-height: 1.6;
            margin-bottom: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .word-definition strong {
            color: #667eea;
        }

        .word-example {
            color: #5a6c7d;
            line-height: 1.6;
            font-style: italic;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 6px;
            border-left: 3px solid #17a2b8;
        }

        .word-example strong {
            color: #17a2b8;
            font-style: normal;
        }

        .no-words {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-words p {
            font-size: 1.1rem;
            margin: 0;
        }

        .quiz-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .quiz-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .quiz-book-image-container {
            width: 150px;
            height: 200px;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e1e5e9;
        }

        .quiz-book-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .quiz-book-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            color: #6c757d;
            font-size: 3rem;
        }

        .quiz-book-details {
            flex: 1;
            min-width: 0;
        }

        .quiz-book-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .quiz-book-info {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #666;
        }

        .quiz-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .quiz-number {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
        }

        .quiz-question {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            line-height: 1.4;
        }

        .quiz-choices {
            margin-bottom: 15px;
        }

        .quiz-choice {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: white;
            border: 2px solid #e1e5e9;
            cursor: pointer;
            user-select: none;
        }

        .quiz-choice:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(5px);
        }

        .quiz-choice.selected {
            background: #e7f3ff;
            border-color: #007bff;
            font-weight: bold;
        }

        .quiz-choice.correct {
            background: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724;
            font-weight: bold;
        }

        .quiz-choice.incorrect {
            background: #f8d7da !important;
            border-color: #dc3545 !important;
            color: #721c24;
            font-weight: bold;
        }

        .quiz-choice.disabled {
            pointer-events: none;
            opacity: 0.8;
        }

        .quiz-answer {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            font-weight: bold;
            color: #0056b3;
            margin-top: 15px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .quiz-answer.show {
            opacity: 1;
            transform: translateY(0);
        }

        .quiz-result {
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .quiz-result.show {
            opacity: 1;
            transform: translateY(0);
        }

        .quiz-result.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .quiz-result.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b2b7;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        .hidden {
            display: none;
        }

        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media (max-width: 768px) {
            body {
                padding-bottom: 20px;
            }

            .container {
                padding: 10px;
            }

            header {
                margin-bottom: 20px;
            }

            header h1 {
                font-size: 1.8rem;
                margin-bottom: 5px;
            }

            header p {
                font-size: 0.9rem;
            }

            /* ÌÜµÍ≥ÑÎ•º ÌïòÎã®ÏúºÎ°ú Ïù¥Îèô */
            .stats-section {
                order: 10;
                padding: 15px;
                margin-top: 30px;
            }

            .stats-toggle-btn {
                display: block;
            }

            .stats-grid {
                display: none;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stats-grid.show {
                display: grid;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.8rem;
            }

            .search-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .search-section h2 {
                font-size: 1.3rem;
                margin-bottom: 15px !important;
            }

            .search-container {
                flex-direction: column;
                gap: 8px;
            }

            .search-input,
            .search-type-select,
            .search-btn,
            .clear-btn {
                width: 100%;
                font-size: 1rem;
                padding: 12px;
            }

            .results-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .results-title {
                font-size: 1.2rem;
            }

            .book-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .book-card {
                padding: 15px;
            }

            .book-title {
                font-size: 1.1rem;
            }

            .book-info {
                font-size: 0.85rem;
                gap: 3px 8px;
            }

            .quiz-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .quiz-header {
                flex-direction: column;
                gap: 15px;
            }

            .quiz-book-image-container {
                width: 120px;
                height: 160px;
                margin: 0 auto;
            }

            .quiz-book-title {
                font-size: 1.1rem;
            }

            .quiz-book-info {
                flex-direction: column;
                gap: 5px;
                font-size: 0.85rem;
            }

            .quiz-item {
                padding: 15px;
                margin-bottom: 15px;
            }

            .quiz-question {
                font-size: 1rem;
                line-height: 1.3;
            }

            .quiz-choice {
                padding: 10px 12px;
                font-size: 0.9rem;
                margin-bottom: 8px;
            }

            .quiz-choice:hover {
                transform: translateX(3px);
            }

            .quiz-answer {
                padding: 12px;
                font-size: 0.9rem;
            }

            .quiz-result {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5rem;
            }

            header p {
                font-size: 0.85rem;
            }

            .stat-number {
                font-size: 1.3rem;
            }

            .book-title {
                font-size: 1rem;
            }

            .quiz-question {
                font-size: 0.95rem;
            }
        }

        /* ÏùΩÎäî Ï§ë ÏÑπÏÖò - Ïª¥Ìå©Ìä∏ */
        .reading-now-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .reading-now-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .reading-now-title {
            font-size: 1.2rem;
            color: #333;
            font-weight: bold;
        }

        /* ÏùΩÎäî Ï§ë Ï±Ö - Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ */
        .reading-now-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .reading-now-grid::-webkit-scrollbar {
            height: 6px;
        }

        .reading-now-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .reading-now-grid::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .reading-now-grid::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Ïª¥Ìå©Ìä∏ Î∂Å Ïπ¥Îìú */
        .compact-book-card {
            min-width: 200px;
            max-width: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            border: 2px solid #e1e5e9;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .compact-book-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .compact-book-image {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 4px;
            margin-bottom: 8px;
            background: white;
        }

        .compact-book-title {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .compact-status-buttons {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }

        .compact-status-btn {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            background: white;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .compact-status-btn:hover {
            border-color: #667eea;
        }

        .compact-status-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            font-weight: bold;
        }

        .compact-action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .compact-quiz-btn {
            flex: 1;
            padding: 6px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .compact-quiz-btn:hover {
            transform: translateY(-2px);
        }

        .compact-quiz-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .compact-words-btn {
            flex: 1;
            padding: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .compact-words-btn:hover {
            transform: translateY(-2px);
        }

        .compact-words-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .view-all-btn {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .view-all-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        /* ÎèÖÏÑú ÏÉÅÌÉú Î≤ÑÌäº */
        .reading-status-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .status-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .status-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .status-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            font-weight: bold;
        }

        .status-btn.started {
            border-color: #ffc107;
        }

        .status-btn.started.active {
            background: #ffc107;
            border-color: #ffc107;
        }

        .status-btn.reading {
            border-color: #17a2b8;
        }

        .status-btn.reading.active {
            background: #17a2b8;
            border-color: #17a2b8;
        }

        .status-btn.completed {
            border-color: #28a745;
        }

        .status-btn.completed.active {
            background: #28a745;
            border-color: #28a745;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .status-badge.started {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.reading {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .reading-dates {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e1e5e9;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-main">
                <h1><a href="#" onclick="goToHome(); return false;" style="color: white; text-decoration: none; cursor: pointer;">üìö Read & Check</a></h1>
            </div>
            <div class="auth-controls" id="authControls">
                <!-- JavaScriptÎ°ú ÎèôÏ†Å ÏÉùÏÑ± -->
            </div>
        </header>

        <!-- ÏùΩÎäî Ï§ëÏù∏ Ï±Ö ÏÑπÏÖò (Î°úÍ∑∏Ïù∏ Ïãú Ìôà ÌôîÎ©¥) -->
        <div id="readingNowSection" class="reading-now-section hidden">
            <div class="reading-now-header">
                <h2 class="reading-now-title">üìñ ÏùΩÎäî Ï§ëÏù∏ Ï±Ö</h2>
            </div>
            <div id="readingNowGrid" class="reading-now-grid"></div>
        </div>

        <!-- Í≤ÄÏÉâ ÏÑπÏÖò -->
        <div class="search-section" id="searchSection">
            <h2 style="margin-bottom: 20px; color: #333;">üîç ÎèÑÏÑú Í≤ÄÏÉâ</h2>
            <div class="search-container">
                <input
                    type="text"
                    id="searchInput"
                    class="search-input"
                    placeholder="ISBN, Ï†úÎ™©, Ï†ÄÏûê, ÏãúÎ¶¨Ï¶àÎ°ú Í≤ÄÏÉâÌïòÏÑ∏Ïöî..."
                    autocomplete="off"
                >
                <select id="searchType" class="search-type-select">
                    <option value="all">Ï†ÑÏ≤¥ Í≤ÄÏÉâ</option>
                    <option value="isbn">ISBN</option>
                    <option value="title">Ï†úÎ™©</option>
                    <option value="author">Ï†ÄÏûê</option>
                    <option value="series">ÏãúÎ¶¨Ï¶à</option>
                </select>
                <button id="searchBtn" class="search-btn">Í≤ÄÏÉâ</button>
                <button id="clearBtn" class="clear-btn">Ï¥àÍ∏∞Ìôî</button>
            </div>

            <!-- Î†àÎ≤® ÌïÑÌÑ∞ -->
            <div class="level-filters">
                <!-- Ï≤´ Î≤àÏß∏ Ìñâ: Î†àÎ≤® ÌïÑÌÑ∞ -->
                <div class="filter-row">
                    <div class="level-filter-group">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="filter-label">BT Level</label>
                            <button class="filter-reset-btn" onclick="resetBTLevelFilter()">Ï†ÑÏ≤¥</button>
                        </div>
                        <div class="dual-range-container">
                            <div class="range-track"></div>
                            <div class="range-progress" id="btLevelProgress"></div>
                            <input type="range" id="btLevelMin" class="range-slider" min="0" max="10" value="0" step="0.5" oninput="updateBTLevelRange()">
                            <input type="range" id="btLevelMax" class="range-slider" min="0" max="10" value="10" step="0.5" oninput="updateBTLevelRange()">
                        </div>
                        <div class="range-values" id="btLevelValues">0.0 ~ 10.0</div>
                    </div>

                    <div class="level-filter-group">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="filter-label">Lexile</label>
                            <button class="filter-reset-btn" onclick="resetLexileFilter()">Ï†ÑÏ≤¥</button>
                        </div>
                        <div class="dual-range-container">
                            <div class="range-track"></div>
                            <div class="range-progress" id="lexileProgress"></div>
                            <input type="range" id="lexileMin" class="range-slider" min="0" max="1500" value="0" step="50" oninput="updateLexileRange()">
                            <input type="range" id="lexileMax" class="range-slider" min="0" max="1500" value="1500" step="50" oninput="updateLexileRange()">
                        </div>
                        <div class="range-values" id="lexileValues">0 ~ 1500</div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label class="filter-label">Ï°∞Í±¥</label>
                        <div class="filter-option-group">
                            <button class="filter-btn active" id="levelConditionAND" onclick="setLevelCondition('AND')">AND</button>
                            <button class="filter-btn" id="levelConditionOR" onclick="setLevelCondition('OR')">OR</button>
                        </div>
                    </div>
                </div>

                <!-- Îëê Î≤àÏß∏ Ìñâ: Ï∂îÍ∞Ä ÌïÑÌÑ∞ -->
                <div class="filter-row">
                    <div style="flex: 1; min-width: 200px;">
                        <label class="filter-label">Ïû•Î•¥</label>
                        <div class="filter-option-group">
                            <button class="filter-btn active" id="genreAll" onclick="setGenre('all')">Ï†ÑÏ≤¥</button>
                            <button class="filter-btn" id="genreFiction" onclick="setGenre('fiction')">Fiction</button>
                            <button class="filter-btn" id="genreNonfiction" onclick="setGenre('nonfiction')">Nonfiction</button>
                        </div>
                    </div>

                    <div style="flex: 1; min-width: 150px;">
                        <label class="filter-label">ÌÄ¥Ï¶à</label>
                        <div class="filter-option-group">
                            <button class="filter-btn active" id="quizAll" onclick="setQuizFilter('all')">Ï†ÑÏ≤¥</button>
                            <button class="filter-btn" id="quizOnly" onclick="setQuizFilter('only')">ÏûàÏùåÎßå</button>
                        </div>
                    </div>

                    <div style="display: flex; align-items: flex-end;">
                        <div class="filter-count" id="filterCount" style="display: none;">
                            <span>Îß§Ïπ≠:</span>
                            <span class="count-number" id="countNumber">0</span>
                            <span>Í∂å</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Í≤ÄÏÉâ Í≤∞Í≥º ÏÑπÏÖò -->
        <div id="resultsSection" class="results-section hidden">
            <div class="results-header">
                <h2 class="results-title" id="resultsTitle">Í≤ÄÏÉâ Í≤∞Í≥º</h2>
                <span class="results-count" id="resultsCount">0Í∞ú Í≤∞Í≥º</span>
            </div>
            <div id="resultsLoading" class="loading hidden">Í≤ÄÏÉâ Ï§ëÏûÖÎãàÎã§...</div>
            <div id="resultsError" class="error hidden"></div>
            <div id="bookGrid" class="book-grid"></div>
        </div>

        <!-- ÌÄ¥Ï¶à ÏÑπÏÖò -->
        <div id="quizSection" class="quiz-section hidden">
            <div class="quiz-header"></div>
            <div id="quizLoading" class="loading hidden">ÌÄ¥Ï¶àÎ•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</div>
            <div id="quizError" class="error hidden"></div>
            <div id="quizList"></div>
        </div>

        <!-- ÎßàÏù¥ÌéòÏù¥ÏßÄ (ÏÉÅÏÑ∏ Í∏∞Î°ù) -->
        <div id="myPageSection" class="results-section hidden">
            <div class="results-header">
                <h2 class="results-title">üìö ÎÇ¥ ÎèÖÏÑú Í∏∞Î°ù</h2>
                <button onclick="goToHome()" class="clear-btn">ÌôàÏúºÎ°ú</button>
            </div>

            <!-- ÎèÖÏÑú ÌÜµÍ≥Ñ -->
            <div id="myStats" style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;"></div>

            <!-- Îã®Ïñ¥ Í≥µÎ∂ÄÌïòÍ∏∞ Î≤ÑÌäº -->
            <div style="margin-bottom: 20px; text-align: center;">
                <button onclick="goToWordStudy()" class="search-btn" style="padding: 12px 30px; font-size: 1rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    üìñ Îã®Ïñ¥ Í≥µÎ∂ÄÌïòÍ∏∞
                </button>
            </div>

            <!-- ÌïÑÌÑ∞ Î≤ÑÌäº -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <h3 style="margin-right: 10px; color: #333; font-size: 1.1rem;">Ï†ÑÏ≤¥ ÎèÖÏÑú Í∏∞Î°ù</h3>
                <button onclick="filterMyBooks('all')" class="status-btn active" id="filterAll">Ï†ÑÏ≤¥</button>
                <button onclick="filterMyBooks('started')" class="status-btn started" id="filterStarted">ÏùΩÍ∏∞ ÏãúÏûë</button>
                <button onclick="filterMyBooks('reading')" class="status-btn reading" id="filterReading">ÏùΩÎäî Ï§ë</button>
                <button onclick="filterMyBooks('completed')" class="status-btn completed" id="filterCompleted">ÏùΩÏùå</button>
            </div>

            <div id="myBooksGrid" class="book-grid"></div>
        </div>

        <!-- Îã®Ïñ¥ ÌïôÏäµ ÌôîÎ©¥ -->
        <div id="wordStudySection" class="results-section hidden">
            <div class="results-header">
                <h2 class="results-title">üìñ Îã®Ïñ¥ Í≥µÎ∂ÄÌïòÍ∏∞</h2>
                <button onclick="goToMyPage()" class="clear-btn">ÎßàÏù¥ÌéòÏù¥ÏßÄÎ°ú</button>
            </div>

            <!-- Î†àÎ≤® ÏÑ†ÌÉù Î∞è ÏòµÏÖò -->
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <!-- Ï†ïÎ†¨ Í∏∞Ï§Ä ÏÑ†ÌÉù -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #333; font-weight: bold; margin-bottom: 10px;">üìä ÎÇúÏù¥ÎèÑ Í∏∞Ï§Ä:</label>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button onclick="changeWordSortBy('bt_level')" class="status-btn active" id="sortByBT">BT Level</button>
                        <button onclick="changeWordSortBy('lexile')" class="status-btn" id="sortByLexile">Lexile</button>
                    </div>
                </div>

                <!-- ÏôÑÎ£å ÏÉÅÌÉú ÌïÑÌÑ∞ (Î°úÍ∑∏Ïù∏Ìïú Í≤ΩÏö∞ÏóêÎßå ÌëúÏãú) -->
                <div id="completionFilterSection" style="margin-bottom: 20px; display: none;">
                    <label style="display: block; color: #333; font-weight: bold; margin-bottom: 10px;">‚úÖ ÌïôÏäµ ÏÉÅÌÉú:</label>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button onclick="changeCompletionFilter('all')" class="status-btn active" id="filterAll">Ï†ÑÏ≤¥</button>
                        <button onclick="changeCompletionFilter('incomplete')" class="status-btn" id="filterIncomplete">ÎØ∏ÏôÑÎ£å</button>
                        <button onclick="changeCompletionFilter('completed')" class="status-btn" id="filterCompleted">ÏôÑÎ£å</button>
                    </div>
                </div>

                <!-- BT Level ÏÑ†ÌÉù -->
                <div id="btLevelRangeSection" style="margin-bottom: 20px;">
                    <label style="display: block; color: #333; font-weight: bold; margin-bottom: 10px;">üéØ BT Level:</label>
                    <div style="position: relative; padding: 10px 0;">
                        <input type="range" id="studyBTLevel" class="range-slider" min="0" max="10" value="1.5" step="0.1"
                               oninput="updateStudyBTLevel()"
                               style="width: 100%; -webkit-appearance: none; appearance: none; height: 6px; border-radius: 3px; background: #e1e5e9; outline: none;">
                        <div id="studyBTLevelValue" style="margin-top: 10px; font-size: 1rem; font-weight: bold; color: #667eea; text-align: center;">
                            BT Level: 1.5
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #999; text-align: center;">
                        Ï¥àÍ∏â(0-3), Ï§ëÍ∏â(3-7), Í≥†Í∏â(7-10)
                    </div>
                </div>

                <!-- Lexile ÏÑ†ÌÉù -->
                <div id="lexileRangeSection" style="margin-bottom: 20px; display: none;">
                    <label style="display: block; color: #333; font-weight: bold; margin-bottom: 10px;">üéØ Lexile:</label>
                    <div style="position: relative; padding: 10px 0;">
                        <input type="range" id="studyLexile" class="range-slider" min="0" max="1500" value="300" step="50"
                               oninput="updateStudyLexile()"
                               style="width: 100%; -webkit-appearance: none; appearance: none; height: 6px; border-radius: 3px; background: #e1e5e9; outline: none;">
                        <div id="studyLexileValue" style="margin-top: 10px; font-size: 1rem; font-weight: bold; color: #667eea; text-align: center;">
                            Lexile: 300
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #999; text-align: center;">
                        Ï¥àÍ∏â(0-500), Ï§ëÍ∏â(500-800), Í≥†Í∏â(800-1500)
                    </div>
                </div>

                <!-- ÏãúÌóò Î≥¥Í∏∞ Î≤ÑÌäº -->
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="goToWordQuiz()" class="search-btn" style="padding: 10px 25px; background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);">
                        ‚úçÔ∏è Îã®Ïñ¥ ÏãúÌóò Î≥¥Í∏∞
                    </button>
                </div>
            </div>

            <!-- ÌïôÏäµ ÏßÑÌñâ ÏÉÅÌÉú -->
            <div id="wordStudyStats" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Ï†ÑÏ≤¥ Îã®Ïñ¥</div>
                        <div id="totalStudyWords" style="font-size: 1.5rem; font-weight: bold; color: #667eea;">-</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ÌòÑÏû¨ ÏßÑÌñâ</div>
                        <div id="currentProgress" style="font-size: 1.5rem; font-weight: bold; color: #f5576c;">-</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Ï†ïÎ†¨ Í∏∞Ï§Ä</div>
                        <div id="currentSortBy" style="font-size: 1.5rem; font-weight: bold; color: #26a69a;">BT Level</div>
                    </div>
                </div>
            </div>

            <!-- Îã®Ïñ¥ Ïπ¥Îìú Î™©Î°ù -->
            <div id="wordStudyLoading" class="loading hidden">Îã®Ïñ¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</div>
            <div id="wordStudyError" class="error hidden"></div>
            <div id="wordCardsList"></div>

            <!-- Îçî Î≥¥Í∏∞ Î≤ÑÌäº -->
            <div id="loadMoreContainer" style="text-align: center; margin-top: 20px; display: none;">
                <button onclick="loadMoreWords()" class="search-btn" style="padding: 10px 30px;">Îçî Î≥¥Í∏∞</button>
            </div>
        </div>

        <!-- Îã®Ïñ¥ ÏãúÌóò ÌôîÎ©¥ -->
        <div id="wordQuizSection" class="results-section hidden">
            <div class="results-header">
                <h2 class="results-title">‚úçÔ∏è Îã®Ïñ¥ ÏãúÌóò</h2>
                <button onclick="goToWordStudy()" class="clear-btn">Îã®Ïñ¥ Í≥µÎ∂ÄÎ°ú</button>
            </div>

            <!-- ÏãúÌóò ÏÑ§Ï†ï (ÏãúÌóò ÏãúÏûë Ï†Ñ) -->
            <div id="quizSetup" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 20px;">ÏãúÌóò Î≤îÏúÑ ÏÑ§Ï†ï</h3>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #666; margin-bottom: 10px; font-weight: bold;">BT Level Î≤îÏúÑ:</label>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="color: #666; margin-right: 5px;">ÏµúÏÜå:</label>
                            <input type="number" id="btLevelMin" value="0" min="0" max="55" step="0.1"
                                   style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: #666; margin-right: 5px;">ÏµúÎåÄ:</label>
                            <input type="number" id="btLevelMax" value="3" min="0" max="55" step="0.1"
                                   style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #999;">
                        Ï∂îÏ≤ú: Ï¥àÍ∏â(0-3), Ï§ëÍ∏â(3-7), Í≥†Í∏â(7-15)
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #666; margin-bottom: 10px; font-weight: bold;">Î¨∏Ï†ú Ïàò:</label>
                    <select id="questionCount" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 150px;">
                        <option value="5">5Î¨∏Ï†ú</option>
                        <option value="10" selected>10Î¨∏Ï†ú</option>
                        <option value="15">15Î¨∏Ï†ú</option>
                        <option value="20">20Î¨∏Ï†ú</option>
                    </select>
                </div>

                <button onclick="startQuiz()" class="search-btn" style="width: 100%; padding: 12px; font-size: 1.1rem;">
                    ÏãúÌóò ÏãúÏûëÌïòÍ∏∞
                </button>
            </div>

            <!-- ÏãúÌóò ÏßÑÌñâ ÌôîÎ©¥ -->
            <div id="quizProgress" class="hidden">
                <!-- ÏßÑÌñâ ÏÉÅÌÉú -->
                <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <span style="color: #666;">ÏßÑÌñâ:</span>
                            <span id="quizProgressText" style="font-weight: bold; color: #667eea; margin-left: 5px;">1 / 10</span>
                        </div>
                        <div>
                            <span style="color: #666;">Ï†ïÎãµ:</span>
                            <span id="quizScoreText" style="font-weight: bold; color: #26a69a; margin-left: 5px;">0 / 0</span>
                        </div>
                        <div>
                            <span style="color: #666;">Ï†ïÎãµÎ•†:</span>
                            <span id="quizAccuracyText" style="font-weight: bold; color: #f5576c; margin-left: 5px;">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Î¨∏Ï†ú Ïπ¥Îìú -->
                <div id="quizQuestionCard" style="background: white; border-radius: 8px; padding: 25px; margin-bottom: 20px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);"></div>
            </div>

            <!-- ÏãúÌóò Í≤∞Í≥º ÌôîÎ©¥ -->
            <div id="quizResult" class="hidden">
                <div style="background: white; border-radius: 8px; padding: 25px; text-align: center;">
                    <h2 style="color: #333; margin-bottom: 20px;">üéâ ÏãúÌóò ÏôÑÎ£å!</h2>
                    <div style="font-size: 3rem; font-weight: bold; color: #667eea; margin: 20px 0;" id="finalScore">0 / 10</div>
                    <div style="font-size: 1.5rem; color: #666; margin-bottom: 30px;" id="finalAccuracy">Ï†ïÎãµÎ•†: 0%</div>

                    <div id="wrongAnswersList" style="margin: 30px 0; text-align: left;"></div>

                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                        <button onclick="retryWrongAnswers()" class="search-btn" style="padding: 12px 25px; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);">
                            ÌãÄÎ¶∞ Î¨∏Ï†ú Îã§Ïãú ÌíÄÍ∏∞
                        </button>
                        <button onclick="goToWordQuiz()" class="search-btn" style="padding: 12px 25px;">
                            ÏÉà ÏãúÌóò Î≥¥Í∏∞
                        </button>
                        <button onclick="goToWordStudy()" class="clear-btn" style="padding: 12px 25px;">
                            Îã®Ïñ¥ Í≥µÎ∂ÄÎ°ú
                        </button>
                    </div>
                </div>
            </div>

            <!-- Î°úÎî©/ÏóêÎü¨ -->
            <div id="quizLoading" class="loading hidden">ÏãúÌóò Î¨∏Ï†úÎ•º ÏÉùÏÑ±ÌïòÎäî Ï§ëÏûÖÎãàÎã§...</div>
            <div id="quizError" class="error hidden"></div>
        </div>

    </div>

    <script>
        // DOM ÏöîÏÜåÎì§
        const searchInput = document.getElementById('searchInput');
        const searchType = document.getElementById('searchType');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultsSection = document.getElementById('resultsSection');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsCount = document.getElementById('resultsCount');
        const resultsLoading = document.getElementById('resultsLoading');
        const resultsError = document.getElementById('resultsError');
        const bookGrid = document.getElementById('bookGrid');
        const quizSection = document.getElementById('quizSection');
        const quizLoading = document.getElementById('quizLoading');
        const quizError = document.getElementById('quizError');
        const quizList = document.getElementById('quizList');

        // ÌÜµÍ≥Ñ ÏöîÏÜåÎì§
        const totalBooks = document.getElementById('totalBooks');
        const booksWithQuiz = document.getElementById('booksWithQuiz');
        const totalQuizzes = document.getElementById('totalQuizzes');
        const totalQuestions = document.getElementById('totalQuestions');
        const statsLoading = document.getElementById('statsLoading');
        const statsError = document.getElementById('statsError');

        // Ï†ÑÏó≠ ÏÉÅÌÉú
        let currentUser = null;
        let currentFilter = 'all';
        let myBooksData = [];
        let wordStudyData = {
            words: [],
            total: 0,
            currentOffset: 0,
            limit: 50,
            sortBy: 'bt_level',
            btLevel: 1.5,      // Single BT Level value
            lexile: 300,       // Single Lexile value
            tolerance: 0.2,    // Tolerance for finding similar level words (¬±0.2)
            completionFilter: 'all' // 'all', 'completed', 'incomplete'
        };

        let wordQuizData = {
            quizzes: [],
            currentIndex: 0,
            correctCount: 0,
            answeredCount: 0,
            userAnswers: [],
            wrongQuestions: []
        };

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkAuthStatus();
        });

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {
            searchBtn.addEventListener('click', handleSearch);
            clearBtn.addEventListener('click', handleClear);

            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });

            // Í≤ÄÏÉâÏñ¥ ÏûÖÎ†• Ïãú Ïã§ÏãúÍ∞Ñ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            searchInput.addEventListener('input', debounce(function() {
                updateFilterCountWithQuery();
            }, 300));
        }

        // Debounce Ìï®Ïàò (ÎÑàÎ¨¥ ÏûêÏ£º Ìò∏Ï∂úÎêòÏßÄ ÏïäÎèÑÎ°ù)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }


        // Í≤ÄÏÉâ Ï≤òÎ¶¨
        async function handleSearch() {
            const query = searchInput.value.trim();

            // Í≤ÄÏÉâÏñ¥Í∞Ä ÏóÜÏúºÎ©¥ ÌïÑÌÑ∞ Ï°∞Í±¥ÏúºÎ°ú Í≤ÄÏÉâ
            if (!query) {
                const count = parseInt(document.getElementById('countNumber').textContent || 0);
                const filterCountVisible = document.getElementById('filterCount').style.display !== 'none';

                if (filterCountVisible && count > 0 && count <= 500) {
                    await browseByFilters();
                } else if (filterCountVisible && count > 500) {
                    alert('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä 500Í∂åÏùÑ Ï¥àÍ≥ºÌï©ÎãàÎã§. Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÌïÑÌÑ∞ Ï°∞Í±¥ÏùÑ Ï°∞Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                } else {
                    alert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÌïÑÌÑ∞ Ï°∞Í±¥ÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                }
                return;
            }

            await performSearch(query, searchType.value);
        }

        // Ïã§Ï†ú Í≤ÄÏÉâ ÏàòÌñâ
        async function performSearch(query, type) {
            showLoading(true);
            hideError();
            hideQuizSection();

            try {
                // ÌïÑÌÑ∞ Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
                const btLevelMin = parseFloat(document.getElementById('btLevelMin').value);
                const btLevelMax = parseFloat(document.getElementById('btLevelMax').value);
                const lexileMin = parseInt(document.getElementById('lexileMin').value);
                const lexileMax = parseInt(document.getElementById('lexileMax').value);

                // URL ÌååÎùºÎØ∏ÌÑ∞ Íµ¨ÏÑ±
                let url = `/api/books/search?q=${encodeURIComponent(query)}&type=${type}`;

                // ÌïÑÌÑ∞Í∞Ä Ï†ÑÏ≤¥ Î≤îÏúÑÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Ï∂îÍ∞Ä
                if (btLevelMin > 0 || btLevelMax < 10) {
                    url += `&btLevelMin=${btLevelMin}&btLevelMax=${btLevelMax}`;
                }
                if (lexileMin > 0 || lexileMax < 1500) {
                    url += `&lexileMin=${lexileMin}&lexileMax=${lexileMax}`;
                }
                if (currentGenre !== 'all') {
                    url += `&genre=${currentGenre}`;
                }
                if (currentQuizFilter === 'only') {
                    url += `&hasQuiz=true`;
                }
                url += `&levelCondition=${currentLevelCondition}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayResults(data, query);
                } else {
                    throw new Error(data.message || 'Í≤ÄÏÉâ Ïã§Ìå®');
                }
            } catch (error) {
                console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
                showError('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú
        function displayResults(data, query) {
            const books = data.data || [];
            resultsTitle.textContent = `"${query}" Í≤ÄÏÉâ Í≤∞Í≥º`;
            resultsCount.textContent = `${books.length}Í∞ú Í≤∞Í≥º`;

            if (books.length === 0) {
                bookGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            } else {
                bookGrid.innerHTML = books.map(book => createBookCard(book)).join('');
            }

            resultsSection.classList.remove('hidden');
        }

        // ÎèÑÏÑú Ïπ¥Îìú ÏÉùÏÑ± (Í≤ÄÏÉâ Í≤∞Í≥ºÏö© - Î°úÍ∑∏Ïù∏ Ïãú ÎèÖÏÑú ÏÉÅÌÉú Î≤ÑÌäº Ìè¨Ìï®)
        function createBookCard(book) {
            // Î°úÍ∑∏Ïù∏ Ïãú ÎèÖÏÑú ÏÉÅÌÉú Î≤ÑÌäºÏù¥ ÏûàÎäî Ïπ¥Îìú ÏÇ¨Ïö©
            if (currentUser) {
                return createBookCardWithStatus(book, false);
            }

            // ÎπÑÎ°úÍ∑∏Ïù∏ Ïãú Í∏∞Î≥∏ Ïπ¥Îìú
            const hasQuiz = book.quiz == 1;
            const imageUrl = book.image_url || `/bookimg/${book.isbn}.jpg`;

            return `
                <div class="book-card">
                    <div class="book-image-container">
                        <img
                            src="${imageUrl}"
                            alt="${escapeHtml(book.title || 'Book cover')}"
                            class="book-image"
                            onerror="this.parentElement.innerHTML='<div class=\\'book-image-placeholder\\'>üìö</div>'"
                        >
                    </div>
                    <div class="book-isbn">ISBN: ${escapeHtml(book.isbn)}</div>
                    <div class="book-title">${escapeHtml(book.title || 'N/A')}</div>
                    <div class="book-info">
                        <span class="book-info-label">Ï†ÄÏûê:</span>
                        <span class="book-info-value">${escapeHtml(book.author || 'N/A')}</span>
                        <span class="book-info-label">ÏãúÎ¶¨Ï¶à:</span>
                        <span class="book-info-value">${escapeHtml(book.series || 'N/A')}</span>
                        <span class="book-info-label">BT Î†àÎ≤®:</span>
                        <span class="book-info-value">
                            ${book.bt_level ? `<span class="ar-level">${book.bt_level}</span>` : 'N/A'}
                        </span>
                        <span class="book-info-label">Lexile:</span>
                        <span class="book-info-value">${escapeHtml(book.lexile || 'N/A')}</span>
                        <span class="book-info-label">ÌÄ¥Ï¶à:</span>
                        <span class="book-info-value">
                            ${hasQuiz ? '<span class="quiz-available">‚úì ÏûàÏùå</span>' : 'ÏóÜÏùå'}
                        </span>
                    </div>
                    <div class="book-actions">
                        <button class="quiz-btn" onclick="loadQuizzes('${book.isbn}')" ${!hasQuiz ? 'disabled' : ''}>
                            ${hasQuiz ? 'ÌÄ¥Ï¶à Î≥¥Í∏∞' : 'ÌÄ¥Ï¶à ÏóÜÏùå'}
                        </button>
                        <button class="words-btn" onclick="loadWords('${book.isbn}')" ${!book.has_words ? 'disabled' : ''}>
                            ${book.has_words ? 'Îã®Ïñ¥ Î≥¥Í∏∞' : 'Îã®Ïñ¥ ÏóÜÏùå'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Ïä¨ÎùºÏù¥Îìú Ìå®ÎÑê Ïó¥Í∏∞
        function openSlidePanel(panelId) {
            const overlay = document.getElementById('slidePanelOverlay');
            const panel = document.getElementById(panelId);

            overlay.classList.add('active');
            setTimeout(() => {
                panel.classList.add('active');
            }, 10);

            // body Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ
            document.body.style.overflow = 'hidden';
        }

        // Ïä¨ÎùºÏù¥Îìú Ìå®ÎÑê Îã´Í∏∞
        function closeSlidePanel() {
            const overlay = document.getElementById('slidePanelOverlay');
            const panels = document.querySelectorAll('.slide-panel');

            panels.forEach(panel => {
                panel.classList.remove('active');
            });

            setTimeout(() => {
                overlay.classList.remove('active');
            }, 300);

            // body Ïä§ÌÅ¨Î°§ Î≥µÏõê
            document.body.style.overflow = '';
        }

        // ÌÄ¥Ï¶à Î™®Îã¨ Ïó¥Í∏∞
        function openQuizModal() {
            const overlay = document.getElementById('quizModalOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // ÌÄ¥Ï¶à Î™®Îã¨ Îã´Í∏∞
        function closeQuizModal(event) {
            // eventÍ∞Ä ÏûàÍ≥† Ïò§Î≤ÑÎ†àÏù¥Î•º ÏßÅÏ†ë ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞Îßå Îã´Í∏∞
            if (event && event.target.className !== 'quiz-modal-overlay active') {
                return;
            }

            const overlay = document.getElementById('quizModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Îã®Ïñ¥ Î°úÎìú
        async function loadWords(isbn) {
            const wordsContent = document.getElementById('wordsContent');
            const wordsLoading = document.getElementById('wordsLoading');
            const wordsError = document.getElementById('wordsError');
            const subtitle = document.getElementById('wordsPanelSubtitle');

            // Ïä¨ÎùºÏù¥Îìú Ìå®ÎÑê Ïó¥Í∏∞
            openSlidePanel('wordsPanel');
            wordsLoading.style.display = 'block';
            wordsError.style.display = 'none';
            wordsContent.innerHTML = '';
            subtitle.textContent = `ISBN: ${isbn}`;

            try {
                const response = await fetch(`/api/books/${isbn}/words`);
                const data = await response.json();

                if (data.success) {
                    displayWords(data.data, isbn);
                } else {
                    throw new Error(data.message || 'Îã®Ïñ¥ Î°úÎìú Ïã§Ìå®');
                }
            } catch (error) {
                console.error('Îã®Ïñ¥ Î°úÎìú Ïò§Î•ò:', error);
                wordsError.textContent = 'Îã®Ïñ¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§: ' + error.message;
                wordsError.style.display = 'block';
            } finally {
                wordsLoading.style.display = 'none';
            }
        }

        // Îã®Ïñ¥ ÌëúÏãú
        function displayWords(data, isbn) {
            const wordsContent = document.getElementById('wordsContent');
            const { word_count, words } = data;

            if (word_count === 0) {
                wordsContent.innerHTML = `
                    <div class="no-words">
                        <p>Ïù¥ Ï±ÖÏóê Îì±Î°ùÎêú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                `;
                return;
            }

            // Îã®Ïñ¥ Î™©Î°ù HTML ÏÉùÏÑ±
            const wordsHTML = words.map((word, index) => {
                const hasDefinition = word.definition && word.definition.trim() !== '';
                const levelInfo = [];
                if (word.min_bt_level) levelInfo.push(`BT ${word.min_bt_level}`);
                if (word.min_lexile) levelInfo.push(`Lexile ${word.min_lexile}`);
                const levelText = levelInfo.length > 0 ? `<span style="color: #667eea; font-size: 0.85rem; font-weight: 500;">üìä ${levelInfo.join(' / ')}</span>` : '';

                return `
                    <div class="word-item">
                        <div class="word-number">${index + 1}</div>
                        <div class="word-content">
                            <div class="word-text">
                                ${escapeHtml(word.word)}
                                ${levelText ? `<span style="margin-left: 10px;">${levelText}</span>` : ''}
                            </div>
                            ${hasDefinition ? `
                                <div class="word-definition">
                                    <strong>Îúª:</strong> ${escapeHtml(word.definition)}
                                </div>
                            ` : ''}
                            ${word.example_sentence ? `
                                <div class="word-example">
                                    <strong>ÏòàÎ¨∏:</strong> ${escapeHtml(word.example_sentence)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            wordsContent.innerHTML = `
                <div class="words-list">
                    ${wordsHTML}
                </div>
            `;

            // ÏÑúÎ∏åÌÉÄÏù¥ÌãÄ ÏóÖÎç∞Ïù¥Ìä∏
            const subtitle = document.getElementById('wordsPanelSubtitle');
            subtitle.textContent = `Ï¥ù ${word_count}Í∞úÏùò Îã®Ïñ¥`;
        }

        // ÌÄ¥Ï¶à Î°úÎìú
        async function loadQuizzes(isbn) {
            const quizContent = document.getElementById('quizContent');
            const quizLoading = document.getElementById('quizLoading');
            const quizError = document.getElementById('quizError');
            const subtitle = document.getElementById('quizModalSubtitle');

            openQuizModal();
            quizLoading.style.display = 'block';
            quizError.style.display = 'none';
            quizContent.innerHTML = '';
            subtitle.textContent = `ISBN: ${isbn}`;

            try {
                const response = await fetch(`/api/books/${isbn}/quizzes`);
                const data = await response.json();

                if (data.success) {
                    displayQuizzes(data);
                } else {
                    throw new Error(data.message || 'ÌÄ¥Ï¶à Î°úÎìú Ïã§Ìå®');
                }
            } catch (error) {
                console.error('ÌÄ¥Ï¶à Î°úÎìú Ïò§Î•ò:', error);
                quizError.textContent = 'ÌÄ¥Ï¶àÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§: ' + error.message;
                quizError.style.display = 'block';
            } finally {
                quizLoading.style.display = 'none';
            }
        }

        // ÌÄ¥Ï¶à ÌëúÏãú
        function displayQuizzes(data) {
            const { book, quizzes } = data;
            const quizContent = document.getElementById('quizContent');
            const subtitle = document.getElementById('quizModalSubtitle');

            subtitle.textContent = `${book.title} - Ï¥ù ${quizzes.length}Í∞úÏùò ÌÄ¥Ï¶à`;

            if (quizzes.length === 0) {
                quizContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Ïù¥ ÎèÑÏÑúÏóê ÎåÄÌïú ÌÄ¥Ï¶àÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            } else {
                quizContent.innerHTML = `
                    <div class="quizzes-list">
                        ${quizzes.map(quiz => createQuizItem(quiz)).join('')}
                    </div>
                `;
            }
        }

        // ÌÄ¥Ï¶à ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
        function createQuizItem(quiz) {
            return `
                <div class="quiz-item" data-question-id="${quiz.question_id}">
                    <div class="quiz-number">Î¨∏Ï†ú ${quiz.question_number}</div>
                    <div class="quiz-question">${escapeHtml(quiz.question_text)}</div>
                    <div class="quiz-choices">
                        <div class="quiz-choice" data-choice="1" onclick="selectChoice(${quiz.question_id}, 1, ${quiz.correct_choice_number})">
                            1. ${escapeHtml(quiz.choice_1)}
                        </div>
                        <div class="quiz-choice" data-choice="2" onclick="selectChoice(${quiz.question_id}, 2, ${quiz.correct_choice_number})">
                            2. ${escapeHtml(quiz.choice_2)}
                        </div>
                        <div class="quiz-choice" data-choice="3" onclick="selectChoice(${quiz.question_id}, 3, ${quiz.correct_choice_number})">
                            3. ${escapeHtml(quiz.choice_3)}
                        </div>
                        <div class="quiz-choice" data-choice="4" onclick="selectChoice(${quiz.question_id}, 4, ${quiz.correct_choice_number})">
                            4. ${escapeHtml(quiz.choice_4)}
                        </div>
                    </div>
                    <div class="quiz-result" id="result-${quiz.question_id}"></div>
                    <div class="quiz-answer" id="answer-${quiz.question_id}">
                        ‚úÖ Ï†ïÎãµ: ${quiz.correct_choice_number}Î≤à - ${escapeHtml(quiz.correct_answer)}
                    </div>
                </div>
            `;
        }

        // ÏÑ†ÌÉùÏßÄ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        function selectChoice(questionId, selectedChoice, correctChoice) {
            const quizItem = document.querySelector(`[data-question-id="${questionId}"]`);
            const choices = quizItem.querySelectorAll('.quiz-choice');
            const resultDiv = document.getElementById(`result-${questionId}`);
            const answerDiv = document.getElementById(`answer-${questionId}`);

            // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú ÌÄ¥Ï¶àÏù∏ÏßÄ ÌôïÏù∏
            if (quizItem.classList.contains('answered')) {
                return;
            }

            // Î™®Îì† ÏÑ†ÌÉùÏßÄ ÎπÑÌôúÏÑ±Ìôî
            choices.forEach(choice => {
                choice.classList.add('disabled');
                const choiceNum = parseInt(choice.dataset.choice);

                // ÏÑ†ÌÉùÌïú ÏÑ†ÌÉùÏßÄ ÌëúÏãú
                if (choiceNum === selectedChoice) {
                    choice.classList.add('selected');
                }

                // Ï†ïÎãµ ÌëúÏãú
                if (choiceNum === correctChoice) {
                    choice.classList.add('correct');
                } else if (choiceNum === selectedChoice && selectedChoice !== correctChoice) {
                    choice.classList.add('incorrect');
                }
            });

            // Í≤∞Í≥º Î©îÏãúÏßÄ ÌëúÏãú
            let resultMessage = '';
            let resultClass = '';

            if (selectedChoice === correctChoice) {
                resultMessage = 'üéâ Ï†ïÎãµÏûÖÎãàÎã§!';
                resultClass = 'correct';
            } else {
                resultMessage = '‚ùå ÌãÄÎ†∏ÏäµÎãàÎã§. Ï†ïÎãµÏùÑ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.';
                resultClass = 'incorrect';
            }

            resultDiv.textContent = resultMessage;
            resultDiv.className = `quiz-result ${resultClass}`;

            // Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú Í≤∞Í≥ºÏôÄ Ï†ïÎãµ ÌëúÏãú
            setTimeout(() => {
                resultDiv.classList.add('show');
            }, 100);

            setTimeout(() => {
                answerDiv.classList.add('show');
            }, 300);

            // ÌÄ¥Ï¶àÎ•º ÎãµÎ≥Ä ÏôÑÎ£åÎ°ú ÌëúÏãú
            quizItem.classList.add('answered');
        }

        // Ï¥àÍ∏∞Ìôî
        function handleClear() {
            searchInput.value = '';
            searchType.value = 'all';

            resultsSection.classList.add('hidden');
            hideQuizSection();
            hideError();

            // ÌôàÏúºÎ°ú Ïù¥Îèô
            goToHome();
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function showLoading(show) {
            resultsLoading.classList.toggle('hidden', !show);
        }

        function showError(message) {
            resultsError.textContent = message;
            resultsError.classList.remove('hidden');
        }

        function hideError() {
            resultsError.classList.add('hidden');
        }

        function showQuizLoading(show) {
            quizLoading.classList.toggle('hidden', !show);
        }

        function showQuizError(message) {
            quizError.textContent = message;
            quizError.classList.remove('hidden');
        }

        function hideQuizError() {
            quizError.classList.add('hidden');
        }

        function hideQuizSection() {
            quizSection.classList.add('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }


        // ============================================
        // Ïù∏Ï¶ù Í¥ÄÎ†® Ìï®Ïàò
        // ============================================

        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            if (!token) {
                showGuestControls();
                showHomeScreen();
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    showUserControls(currentUser);
                    // Î°úÍ∑∏Ïù∏ Ïãú Ìôà ÌôîÎ©¥ ÌëúÏãú (ÏùΩÎäî Ï§ë + Í≤ÄÏÉâ)
                    await showHomeScreen();
                } else {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    showGuestControls();
                    showHomeScreen();
                }
            } catch (error) {
                console.error('Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò:', error);
                showGuestControls();
                showHomeScreen();
            }
        }

        function showUserControls(user) {
            const authControls = document.getElementById('authControls');
            authControls.innerHTML = `
                <a href="#" onclick="showMyPage(); return false;" class="user-info" style="cursor: pointer; text-decoration: none;">üë§ ${escapeHtml(user.username)}</a>
                <button onclick="handleLogout()" class="auth-btn">Î°úÍ∑∏ÏïÑÏõÉ</button>
            `;
        }

        function showGuestControls() {
            const authControls = document.getElementById('authControls');
            authControls.innerHTML = `
                <a href="/auth.html" class="auth-btn">Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ</a>
            `;
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                localStorage.removeItem('token');
                localStorage.removeItem('user');
                currentUser = null;

                showGuestControls();
                showHomeScreen();
                alert('Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§.');
            } catch (error) {
                console.error('Î°úÍ∑∏ÏïÑÏõÉ Ïò§Î•ò:', error);
            }
        }

        // Ìôà ÌôîÎ©¥ ÌëúÏãú
        async function showHomeScreen() {
            // Î™®Îì† ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            document.getElementById('myPageSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('quizSection').classList.add('hidden');

            // Í≤ÄÏÉâ ÏÑπÏÖò Ìï≠ÏÉÅ ÌëúÏãú
            document.getElementById('searchSection').classList.remove('hidden');

            // Î°úÍ∑∏Ïù∏ Ïãú ÏùΩÎäî Ï§ë ÏÑπÏÖò Î°úÎìú
            if (currentUser) {
                await loadReadingNow();
            } else {
                document.getElementById('readingNowSection').classList.add('hidden');
            }

            // Îß® ÏúÑÎ°ú Ïä§ÌÅ¨Î°§
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ÌôàÏúºÎ°ú Ïù¥Îèô
        function goToHome() {
            showHomeScreen();
        }

        // ============================================
        // ÏùΩÎäî Ï§ë ÏÑπÏÖò
        // ============================================

        async function loadReadingNow() {
            if (!currentUser) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/reading/history?status=reading', {
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    const readingNowGrid = document.getElementById('readingNowGrid');
                    readingNowGrid.innerHTML = data.data.map(book => createCompactBookCard(book)).join('');
                    document.getElementById('readingNowSection').classList.remove('hidden');
                } else {
                    document.getElementById('readingNowSection').classList.add('hidden');
                }
            } catch (error) {
                console.error('ÏùΩÎäî Ï§ëÏù∏ Ï±Ö Î°úÎìú Ïò§Î•ò:', error);
            }
        }

        // Ïª¥Ìå©Ìä∏ Î∂Å Ïπ¥Îìú ÏÉùÏÑ± (ÏùΩÎäî Ï§ë ÏÑπÏÖòÏö©)
        function createCompactBookCard(book) {
            const hasQuiz = book.quiz == 1;
            const imageUrl = book.image_url || `/bookimg/${book.isbn}.jpg`;
            const currentStatus = book.status || 'reading';

            return `
                <div class="compact-book-card">
                    <img
                        src="${imageUrl}"
                        alt="${escapeHtml(book.title || 'Book cover')}"
                        class="compact-book-image"
                        onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22120%22><rect width=%22200%22 height=%22120%22 fill=%22%23e9ecef%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2240%22>üìö</text></svg>'"
                    >
                    <div class="compact-book-title">${escapeHtml(book.title || 'N/A')}</div>
                    <div class="compact-status-buttons">
                        <button class="compact-status-btn ${currentStatus === 'started' ? 'active' : ''}" onclick="updateReadingStatus('${book.isbn}', 'started', event)" title="ÏùΩÍ∏∞ ÏãúÏûë">ÏãúÏûë</button>
                        <button class="compact-status-btn ${currentStatus === 'reading' ? 'active' : ''}" onclick="updateReadingStatus('${book.isbn}', 'reading', event)" title="ÏùΩÎäî Ï§ë">ÏßÑÌñâ</button>
                        <button class="compact-status-btn ${currentStatus === 'completed' ? 'active' : ''}" onclick="updateReadingStatus('${book.isbn}', 'completed', event)" title="ÏùΩÏùå">ÏôÑÎ£å</button>
                    </div>
                    <div class="compact-action-buttons">
                        <button class="compact-quiz-btn" onclick="loadQuizzes('${book.isbn}')" ${!hasQuiz ? 'disabled' : ''}>
                            ${hasQuiz ? 'ÌÄ¥Ï¶à' : 'ÌÄ¥Ï¶à ÏóÜÏùå'}
                        </button>
                        <button class="compact-words-btn" onclick="loadWords('${book.isbn}')" ${!book.has_words ? 'disabled' : ''}>
                            ${book.has_words ? 'Îã®Ïñ¥' : 'Îã®Ïñ¥ ÏóÜÏùå'}
                        </button>
                    </div>
                </div>
            `;
        }

        // ============================================
        // ÎßàÏù¥ÌéòÏù¥ÏßÄ
        // ============================================

        async function showMyPage() {
            if (!currentUser) {
                alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                window.location.href = '/auth.html';
                return;
            }

            // Î™®Îì† ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            document.getElementById('readingNowSection').classList.add('hidden');
            document.getElementById('searchSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('quizSection').classList.add('hidden');

            // ÎßàÏù¥ÌéòÏù¥ÏßÄ ÌëúÏãú
            document.getElementById('myPageSection').classList.remove('hidden');

            await loadMyBooks();
            await loadMyStats();

            // Îß® ÏúÑÎ°ú Ïä§ÌÅ¨Î°§
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function loadMyBooks(status = null) {
            if (!currentUser) return;

            try {
                const token = localStorage.getItem('token');
                const url = status ? `/api/reading/history?status=${status}` : '/api/reading/history';

                const response = await fetch(url, {
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    myBooksData = data.data;
                    displayMyBooks(myBooksData);
                }
            } catch (error) {
                console.error('ÎÇ¥ Ï±Ö Î°úÎìú Ïò§Î•ò:', error);
            }
        }

        function displayMyBooks(books) {
            const grid = document.getElementById('myBooksGrid');

            if (books.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>ÏïÑÏßÅ ÎèÖÏÑú Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Ï±ÖÏùÑ Í≤ÄÏÉâÌïòÍ≥† ÎèÖÏÑú ÏÉÅÌÉúÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = books.map(book => createBookCardWithStatus(book, true)).join('');
        }

        async function loadMyStats() {
            if (!currentUser) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/reading/stats', {
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('myStats').innerHTML = `
                        <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                            <div class="stat-number">${stats.started_count || 0}</div>
                            <div class="stat-label">ÏùΩÍ∏∞ ÏãúÏûë</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                            <div class="stat-number">${stats.reading_count || 0}</div>
                            <div class="stat-label">ÏùΩÎäî Ï§ë</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                            <div class="stat-number">${stats.completed_count || 0}</div>
                            <div class="stat-label">ÏùΩÏùå</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.total_count || 0}</div>
                            <div class="stat-label">Ï†ÑÏ≤¥</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ÌÜµÍ≥Ñ Î°úÎìú Ïò§Î•ò:', error);
            }
        }

        function filterMyBooks(status) {
            currentFilter = status;

            // Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            ['All', 'Started', 'Reading', 'Completed'].forEach(s => {
                document.getElementById(`filter${s}`).classList.remove('active');
            });
            document.getElementById(`filter${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.add('active');

            if (status === 'all') {
                displayMyBooks(myBooksData);
            } else {
                const filtered = myBooksData.filter(book => book.status === status);
                displayMyBooks(filtered);
            }
        }

        // ============================================
        // ÎèÖÏÑú ÏÉÅÌÉú Í¥ÄÎ¶¨
        // ============================================

        async function updateReadingStatus(isbn, status, event) {
            if (!currentUser) {
                alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                window.location.href = '/auth.html';
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Ï†ÄÏû• Ï§ë...';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/reading/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include',
                    body: JSON.stringify({ isbn, status })
                });

                const data = await response.json();

                if (data.success) {
                    // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    const card = button.closest('.book-card, .compact-book-card');
                    if (card) {
                        const buttons = card.querySelectorAll('.status-btn, .compact-status-btn');
                        buttons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    }

                    // ÏùΩÎäî Ï§ë ÏÑπÏÖò ÏÉàÎ°úÍ≥†Ïπ®
                    if (currentUser) {
                        await loadReadingNow();
                    }

                    button.textContent = originalText;
                    button.disabled = false;
                } else {
                    alert(data.message || 'ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    button.textContent = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                console.error('ÎèÖÏÑú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                alert('ÎèÖÏÑú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // ============================================
        // Ï±Ö Ïπ¥Îìú ÏÉùÏÑ± (ÎèÖÏÑú ÏÉÅÌÉú Ìè¨Ìï®)
        // ============================================

        function createBookCardWithStatus(book, showDates = false) {
            const hasQuiz = book.quiz == 1;
            const imageUrl = book.image_url || `/bookimg/${book.isbn}.jpg`;
            const currentStatus = book.status || null;

            let statusBadge = '';
            if (currentStatus) {
                const statusLabels = {
                    started: 'ÏùΩÍ∏∞ ÏãúÏûë',
                    reading: 'ÏùΩÎäî Ï§ë',
                    completed: 'ÏùΩÏùå'
                };
                statusBadge = `<div class="status-badge ${currentStatus}">${statusLabels[currentStatus]}</div>`;
            }

            let datesInfo = '';
            if (showDates && currentStatus) {
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
                };

                datesInfo = `
                    <div class="reading-dates">
                        ${book.started_at ? `üìÖ ÏãúÏûë: ${formatDate(book.started_at)}` : ''}
                        ${book.reading_at ? `<br>üìñ ÏùΩÎäîÏ§ë: ${formatDate(book.reading_at)}` : ''}
                        ${book.completed_at ? `<br>‚úÖ ÏôÑÎ£å: ${formatDate(book.completed_at)}` : ''}
                    </div>
                `;
            }

            return `
                <div class="book-card">
                    ${statusBadge}
                    <div class="book-image-container">
                        <img
                            src="${imageUrl}"
                            alt="${escapeHtml(book.title || 'Book cover')}"
                            class="book-image"
                            onerror="this.parentElement.innerHTML='<div class=\\'book-image-placeholder\\'>üìö</div>'"
                        >
                    </div>
                    <div class="book-isbn">ISBN: ${escapeHtml(book.isbn)}</div>
                    <div class="book-title">${escapeHtml(book.title || 'N/A')}</div>
                    <div class="book-info">
                        <span class="book-info-label">Ï†ÄÏûê:</span>
                        <span class="book-info-value">${escapeHtml(book.author || 'N/A')}</span>
                        <span class="book-info-label">ÏãúÎ¶¨Ï¶à:</span>
                        <span class="book-info-value">${escapeHtml(book.series || 'N/A')}</span>
                        <span class="book-info-label">BT Î†àÎ≤®:</span>
                        <span class="book-info-value">
                            ${book.bt_level ? `<span class="ar-level">${book.bt_level}</span>` : 'N/A'}
                        </span>
                        <span class="book-info-label">Lexile:</span>
                        <span class="book-info-value">${escapeHtml(book.lexile || 'N/A')}</span>
                        <span class="book-info-label">ÌÄ¥Ï¶à:</span>
                        <span class="book-info-value">
                            ${hasQuiz ? '<span class="quiz-available">‚úì ÏûàÏùå</span>' : 'ÏóÜÏùå'}
                        </span>
                    </div>
                    ${datesInfo}
                    ${currentUser ? `
                        <div class="reading-status-buttons">
                            <button class="status-btn started ${currentStatus === 'started' ? 'active' : ''}" onclick="updateReadingStatus('${book.isbn}', 'started', event)">ÏùΩÍ∏∞ ÏãúÏûë</button>
                            <button class="status-btn reading ${currentStatus === 'reading' ? 'active' : ''}" onclick="updateReadingStatus('${book.isbn}', 'reading', event)">ÏùΩÎäî Ï§ë</button>
                            <button class="status-btn completed ${currentStatus === 'completed' ? 'active' : ''}" onclick="updateReadingStatus('${book.isbn}', 'completed', event)">ÏùΩÏùå</button>
                        </div>
                    ` : ''}
                    <div class="book-actions">
                        <button class="quiz-btn" onclick="loadQuizzes('${book.isbn}')" ${!hasQuiz ? 'disabled' : ''}>
                            ${hasQuiz ? 'ÌÄ¥Ï¶à Î≥¥Í∏∞' : 'ÌÄ¥Ï¶à ÏóÜÏùå'}
                        </button>
                        <button class="words-btn" onclick="loadWords('${book.isbn}')" ${!book.has_words ? 'disabled' : ''}>
                            ${book.has_words ? 'Îã®Ïñ¥ Î≥¥Í∏∞' : 'Îã®Ïñ¥ ÏóÜÏùå'}
                        </button>
                    </div>
                </div>
            `;
        }

        // ÌïÑÌÑ∞ ÏÉÅÌÉú Î≥ÄÏàò
        let currentGenre = 'all';
        let currentQuizFilter = 'all';
        let currentLevelCondition = 'AND';

        // Î†àÎ≤® ÌïÑÌÑ∞ Ìï®ÏàòÎì§
        function updateBTLevelRange() {
            const minSlider = document.getElementById('btLevelMin');
            const maxSlider = document.getElementById('btLevelMax');
            const valuesDisplay = document.getElementById('btLevelValues');
            const progress = document.getElementById('btLevelProgress');

            let minValue = parseFloat(minSlider.value);
            let maxValue = parseFloat(maxSlider.value);

            // minÏù¥ maxÎ≥¥Îã§ ÌÅ¨Î©¥ Ï°∞Ï†ï
            if (minValue > maxValue) {
                minSlider.value = maxValue;
                minValue = maxValue;
            }

            valuesDisplay.textContent = `${minValue.toFixed(1)} ~ ${maxValue.toFixed(1)}`;

            // ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            const min = parseFloat(minSlider.min);
            const max = parseFloat(minSlider.max);
            const leftPercent = ((minValue - min) / (max - min)) * 100;
            const rightPercent = ((maxValue - min) / (max - min)) * 100;
            progress.style.left = leftPercent + '%';
            progress.style.width = (rightPercent - leftPercent) + '%';

            updateFilterCount();
        }

        function updateLexileRange() {
            const minSlider = document.getElementById('lexileMin');
            const maxSlider = document.getElementById('lexileMax');
            const valuesDisplay = document.getElementById('lexileValues');
            const progress = document.getElementById('lexileProgress');

            let minValue = parseInt(minSlider.value);
            let maxValue = parseInt(maxSlider.value);

            // minÏù¥ maxÎ≥¥Îã§ ÌÅ¨Î©¥ Ï°∞Ï†ï
            if (minValue > maxValue) {
                minSlider.value = maxValue;
                minValue = maxValue;
            }

            valuesDisplay.textContent = `${minValue} ~ ${maxValue}`;

            // ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            const min = parseInt(minSlider.min);
            const max = parseInt(minSlider.max);
            const leftPercent = ((minValue - min) / (max - min)) * 100;
            const rightPercent = ((maxValue - min) / (max - min)) * 100;
            progress.style.left = leftPercent + '%';
            progress.style.width = (rightPercent - leftPercent) + '%';

            updateFilterCount();
        }

        function resetBTLevelFilter() {
            document.getElementById('btLevelMin').value = 0;
            document.getElementById('btLevelMax').value = 10;
            updateBTLevelRange();
        }

        function resetLexileFilter() {
            document.getElementById('lexileMin').value = 0;
            document.getElementById('lexileMax').value = 1500;
            updateLexileRange();
        }

        // Ïû•Î•¥ ÌïÑÌÑ∞
        function setGenre(genre) {
            currentGenre = genre;
            document.getElementById('genreAll').classList.remove('active');
            document.getElementById('genreFiction').classList.remove('active');
            document.getElementById('genreNonfiction').classList.remove('active');

            if (genre === 'all') {
                document.getElementById('genreAll').classList.add('active');
            } else if (genre === 'fiction') {
                document.getElementById('genreFiction').classList.add('active');
            } else {
                document.getElementById('genreNonfiction').classList.add('active');
            }

            updateFilterCount();
        }

        // ÌÄ¥Ï¶à ÌïÑÌÑ∞
        function setQuizFilter(filter) {
            currentQuizFilter = filter;
            document.getElementById('quizAll').classList.remove('active');
            document.getElementById('quizOnly').classList.remove('active');

            if (filter === 'all') {
                document.getElementById('quizAll').classList.add('active');
            } else {
                document.getElementById('quizOnly').classList.add('active');
            }

            updateFilterCount();
        }

        // Î†àÎ≤® Ï°∞Í±¥ (AND/OR)
        function setLevelCondition(condition) {
            currentLevelCondition = condition;
            document.getElementById('levelConditionAND').classList.remove('active');
            document.getElementById('levelConditionOR').classList.remove('active');

            if (condition === 'AND') {
                document.getElementById('levelConditionAND').classList.add('active');
            } else {
                document.getElementById('levelConditionOR').classList.add('active');
            }

            updateFilterCount();
        }

        // ÌïÑÌÑ∞ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        async function updateFilterCount() {
            const btLevelMin = parseFloat(document.getElementById('btLevelMin').value);
            const btLevelMax = parseFloat(document.getElementById('btLevelMax').value);
            const lexileMin = parseInt(document.getElementById('lexileMin').value);
            const lexileMax = parseInt(document.getElementById('lexileMax').value);

            // ÌïÑÌÑ∞Í∞Ä Í∏∞Î≥∏Í∞íÏù¥Î©¥ Ïπ¥Ïö¥Ìä∏ Ïà®Í∏∞Í∏∞
            if (btLevelMin === 0 && btLevelMax === 10 &&
                lexileMin === 0 && lexileMax === 1500 &&
                currentGenre === 'all' && currentQuizFilter === 'all') {
                document.getElementById('filterCount').style.display = 'none';
                return;
            }

            try {
                let url = '/api/books/filter-count?';
                const params = [];

                if (btLevelMin > 0 || btLevelMax < 10) {
                    params.push(`btLevelMin=${btLevelMin}&btLevelMax=${btLevelMax}`);
                }
                if (lexileMin > 0 || lexileMax < 1500) {
                    params.push(`lexileMin=${lexileMin}&lexileMax=${lexileMax}`);
                }
                if (currentGenre !== 'all') {
                    params.push(`genre=${currentGenre}`);
                }
                if (currentQuizFilter === 'only') {
                    params.push(`hasQuiz=true`);
                }
                params.push(`levelCondition=${currentLevelCondition}`);

                url += params.join('&');

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('countNumber').textContent = data.count;
                    document.getElementById('filterCount').style.display = 'inline-flex';
                }
            } catch (error) {
                console.error('ÌïÑÌÑ∞ Ïπ¥Ïö¥Ìä∏ Ïò§Î•ò:', error);
            }
        }

        // Í≤ÄÏÉâÏñ¥Î•º Ìè¨Ìï®Ìïú ÌïÑÌÑ∞ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        async function updateFilterCountWithQuery() {
            const query = searchInput.value.trim();
            const searchType = document.getElementById('searchType').value;
            const btLevelMin = parseFloat(document.getElementById('btLevelMin').value);
            const btLevelMax = parseFloat(document.getElementById('btLevelMax').value);
            const lexileMin = parseInt(document.getElementById('lexileMin').value);
            const lexileMax = parseInt(document.getElementById('lexileMax').value);

            // Í≤ÄÏÉâÏñ¥Í∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ ÌïÑÌÑ∞ Ïπ¥Ïö¥Ìä∏ ÏÇ¨Ïö©
            if (!query) {
                updateFilterCount();
                return;
            }

            // ÌïÑÌÑ∞Í∞Ä Î™®Îëê Í∏∞Î≥∏Í∞íÏù¥Î©¥ Ïπ¥Ïö¥Ìä∏ Ïà®Í∏∞Í∏∞
            const hasFilter = (btLevelMin > 0 || btLevelMax < 10 ||
                             lexileMin > 0 || lexileMax < 1500 ||
                             currentGenre !== 'all' || currentQuizFilter === 'only');

            if (!hasFilter) {
                document.getElementById('filterCount').style.display = 'none';
                return;
            }

            try {
                let url = `/api/books/search-count?q=${encodeURIComponent(query)}&type=${searchType}`;
                const params = [];

                if (btLevelMin > 0 || btLevelMax < 10) {
                    params.push(`btLevelMin=${btLevelMin}&btLevelMax=${btLevelMax}`);
                }
                if (lexileMin > 0 || lexileMax < 1500) {
                    params.push(`lexileMin=${lexileMin}&lexileMax=${lexileMax}`);
                }
                if (currentGenre !== 'all') {
                    params.push(`genre=${currentGenre}`);
                }
                if (currentQuizFilter === 'only') {
                    params.push(`hasQuiz=true`);
                }
                params.push(`levelCondition=${currentLevelCondition}`);

                if (params.length > 0) {
                    url += '&' + params.join('&');
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('countNumber').textContent = data.count;
                    document.getElementById('filterCount').style.display = 'inline-flex';
                }
            } catch (error) {
                console.error('Í≤ÄÏÉâ Ïπ¥Ïö¥Ìä∏ Ïò§Î•ò:', error);
            }
        }

        // ÌïÑÌÑ∞ Ï°∞Í±¥ÏúºÎ°ú ÏßÅÏ†ë Í≤ÄÏÉâ (Í≤ÄÏÉâÏñ¥ ÏóÜÏù¥)
        async function browseByFilters() {
            const count = parseInt(document.getElementById('countNumber').textContent);

            if (count === 0) {
                showError('Ï°∞Í±¥Ïóê ÎßûÎäî Ï±ÖÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }

            if (count > 500) {
                showError('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä 500Í∂åÏùÑ Ï¥àÍ≥ºÌï©ÎãàÎã§. Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÌïÑÌÑ∞ Ï°∞Í±¥ÏùÑ Ï°∞Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            showLoading(true);
            hideError();

            try {
                const btLevelMin = parseFloat(document.getElementById('btLevelMin').value);
                const btLevelMax = parseFloat(document.getElementById('btLevelMax').value);
                const lexileMin = parseInt(document.getElementById('lexileMin').value);
                const lexileMax = parseInt(document.getElementById('lexileMax').value);

                let url = '/api/books/browse?';
                const params = [];

                if (btLevelMin > 0 || btLevelMax < 10) {
                    params.push(`btLevelMin=${btLevelMin}&btLevelMax=${btLevelMax}`);
                }
                if (lexileMin > 0 || lexileMax < 1500) {
                    params.push(`lexileMin=${lexileMin}&lexileMax=${lexileMax}`);
                }
                if (currentGenre !== 'all') {
                    params.push(`genre=${currentGenre}`);
                }
                if (currentQuizFilter === 'only') {
                    params.push(`hasQuiz=true`);
                }
                params.push(`levelCondition=${currentLevelCondition}`);

                url += params.join('&');

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayResults(data, 'ÌïÑÌÑ∞ Ï°∞Í±¥');
                } else {
                    throw new Error(data.message || 'Ï°∞Ìöå Ïã§Ìå®');
                }
            } catch (error) {
                console.error('ÌïÑÌÑ∞ Ï°∞Ìöå Ïò§Î•ò:', error);
                showError('Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Í∏ÄÎ°úÎ≤å Ìï®ÏàòÎì§ (HTMLÏóêÏÑú Ìò∏Ï∂ú)
        window.loadQuizzes = loadQuizzes;
        window.loadWords = loadWords;
        window.closeWordsModal = closeWordsModal;
        window.selectChoice = selectChoice;
        window.showMyPage = showMyPage;
        window.filterMyBooks = filterMyBooks;
        window.updateReadingStatus = updateReadingStatus;
        window.handleLogout = handleLogout;
        window.goToHome = goToHome;
        window.showHomeScreen = showHomeScreen;
        window.updateBTLevelRange = updateBTLevelRange;
        window.updateLexileRange = updateLexileRange;
        window.resetBTLevelFilter = resetBTLevelFilter;
        window.resetLexileFilter = resetLexileFilter;
        window.setGenre = setGenre;
        window.setQuizFilter = setQuizFilter;
        window.setLevelCondition = setLevelCondition;
        window.browseByFilters = browseByFilters;

        // ===== Îã®Ïñ¥ ÌïôÏäµ Í∏∞Îä• =====
        // wordStudyDataÎäî Ï†ÑÏó≠ ÏÉÅÌÉúÏóêÏÑú ÏÑ†Ïñ∏Îê®

        // Îã®Ïñ¥ Í≥µÎ∂ÄÌïòÍ∏∞ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
        async function goToWordStudy() {
            console.log('goToWordStudy called');
            try {
                // Î™®Îì† ÏÑπÏÖò Ïà®Í∏∞Í∏∞
                const sections = ['searchSection', 'resultsSection', 'quizSection', 'myPageSection', 'wordQuizSection', 'readingNowSection'];
                sections.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.classList.add('hidden');
                });

                document.getElementById('wordStudySection').classList.remove('hidden');

                // ÏôÑÎ£å ÌïÑÌÑ∞ ÏÑπÏÖò ÌëúÏãú/Ïà®ÍπÄ (Î°úÍ∑∏Ïù∏ Ïó¨Î∂ÄÏóê Îî∞Îùº)
                const completionFilterSection = document.getElementById('completionFilterSection');
                if (completionFilterSection) {
                    completionFilterSection.style.display = currentUser ? 'block' : 'none';
                }

                // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                wordStudyData.words = [];
                wordStudyData.currentOffset = 0;

                // Îã®Ïñ¥ Î°úÎìú
                await loadStudyWords();
            } catch (error) {
                console.error('goToWordStudy error:', error);
                alert('Îã®Ïñ¥ Í≥µÎ∂Ä ÌéòÏù¥ÏßÄÎ•º Ïó¨Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // Îã®Ïñ¥ Ï†ïÎ†¨ Í∏∞Ï§Ä Î≥ÄÍ≤Ω
        async function changeWordSortBy(sortBy) {
            wordStudyData.sortBy = sortBy;
            wordStudyData.words = [];
            wordStudyData.currentOffset = 0;

            // Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.getElementById('sortByBT').classList.toggle('active', sortBy === 'bt_level');
            document.getElementById('sortByLexile').classList.toggle('active', sortBy === 'lexile');

            // Î≤îÏúÑ ÏÑπÏÖò ÌëúÏãú/Ïà®ÍπÄ
            document.getElementById('btLevelRangeSection').style.display = sortBy === 'bt_level' ? 'block' : 'none';
            document.getElementById('lexileRangeSection').style.display = sortBy === 'lexile' ? 'block' : 'none';

            // Ï†ïÎ†¨ Í∏∞Ï§Ä ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('currentSortBy').textContent = sortBy === 'bt_level' ? 'BT Level' : 'Lexile';

            // Îã®Ïñ¥ Îã§Ïãú Î°úÎìú
            await loadStudyWords();
        }

        // BT Level Ïä¨ÎùºÏù¥Îçî ÏóÖÎç∞Ïù¥Ìä∏
        async function updateStudyBTLevel() {
            const value = parseFloat(document.getElementById('studyBTLevel').value);
            wordStudyData.btLevel = value;
            document.getElementById('studyBTLevelValue').textContent = `BT Level: ${value.toFixed(1)}`;

            // Îã®Ïñ¥ Îã§Ïãú Î°úÎìú
            wordStudyData.words = [];
            wordStudyData.currentOffset = 0;
            await loadStudyWords();
        }

        // Lexile Ïä¨ÎùºÏù¥Îçî ÏóÖÎç∞Ïù¥Ìä∏
        async function updateStudyLexile() {
            const value = parseInt(document.getElementById('studyLexile').value);
            wordStudyData.lexile = value;
            document.getElementById('studyLexileValue').textContent = `Lexile: ${value}`;

            // Îã®Ïñ¥ Îã§Ïãú Î°úÎìú
            wordStudyData.words = [];
            wordStudyData.currentOffset = 0;
            await loadStudyWords();
        }

        // Îã®Ïñ¥ Î°úÎìú
        async function loadStudyWords() {
            const wordStudyLoading = document.getElementById('wordStudyLoading');
            const wordStudyError = document.getElementById('wordStudyError');
            const wordCardsList = document.getElementById('wordCardsList');
            const loadMoreContainer = document.getElementById('loadMoreContainer');

            try {
                // Î°úÎî© ÌëúÏãú
                if (wordStudyData.currentOffset === 0) {
                    wordStudyLoading.classList.remove('hidden');
                    wordStudyError.classList.add('hidden');
                    wordCardsList.innerHTML = '';
                }

                // URL ÌååÎùºÎØ∏ÌÑ∞ Íµ¨ÏÑ± - ÏÑ†ÌÉùÌïú Î†àÎ≤®Î∂ÄÌÑ∞ Îçî Ïñ¥Î†§Ïö¥ Î†àÎ≤®ÍπåÏßÄ
                let url = `/api/words/study?sortBy=${wordStudyData.sortBy}&limit=${wordStudyData.limit}&offset=${wordStudyData.currentOffset}&completionFilter=${wordStudyData.completionFilter}`;

                if (wordStudyData.sortBy === 'bt_level') {
                    const btLevel = wordStudyData.btLevel;
                    const range = wordStudyData.tolerance * 2; // ÏÑ†ÌÉùÌïú Î†àÎ≤®Î∂ÄÌÑ∞ ÏúÑÎ°úÎßå Î≤îÏúÑ Ï†ÅÏö©
                    url += `&btLevelMin=${btLevel}&btLevelMax=${btLevel + range}`;
                } else {
                    const lexile = wordStudyData.lexile;
                    const range = 200; // LexileÏùÄ ÏÑ†ÌÉùÌïú Î†àÎ≤®Î∂ÄÌÑ∞ ÏúÑÎ°ú 200 Î≤îÏúÑ
                    url += `&lexileMin=${lexile}&lexileMax=${lexile + range}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Îã®Ïñ¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }

                // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                wordStudyData.total = data.data.total;
                wordStudyData.words = wordStudyData.words.concat(data.data.words);

                // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('totalStudyWords').textContent = wordStudyData.total.toLocaleString();
                document.getElementById('currentProgress').textContent = `${wordStudyData.words.length} / ${wordStudyData.total}`;

                // Îã®Ïñ¥ Ïπ¥Îìú Î†åÎçîÎßÅ
                renderWordCards(data.data.words, wordStudyData.currentOffset === 0);

                // Îçî Î≥¥Í∏∞ Î≤ÑÌäº ÌëúÏãú Ïó¨Î∂Ä
                if (wordStudyData.words.length < wordStudyData.total) {
                    loadMoreContainer.style.display = 'block';
                } else {
                    loadMoreContainer.style.display = 'none';
                }

                wordStudyLoading.classList.add('hidden');

            } catch (error) {
                console.error('Îã®Ïñ¥ Î°úÎìú Ïò§Î•ò:', error);
                wordStudyLoading.classList.add('hidden');
                wordStudyError.textContent = error.message;
                wordStudyError.classList.remove('hidden');
            }
        }

        // Îçî Î≥¥Í∏∞
        async function loadMoreWords() {
            wordStudyData.currentOffset += wordStudyData.limit;
            await loadStudyWords();
        }

        // ÏôÑÎ£å ÏÉÅÌÉú ÌïÑÌÑ∞ Î≥ÄÍ≤Ω
        async function changeCompletionFilter(filter) {
            wordStudyData.completionFilter = filter;
            wordStudyData.words = [];
            wordStudyData.currentOffset = 0;

            // Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.getElementById('filterAll').classList.toggle('active', filter === 'all');
            document.getElementById('filterIncomplete').classList.toggle('active', filter === 'incomplete');
            document.getElementById('filterCompleted').classList.toggle('active', filter === 'completed');

            // Îã®Ïñ¥ Îã§Ïãú Î°úÎìú
            await loadStudyWords();
        }

        // Îã®Ïñ¥ ÏôÑÎ£å ÏÉÅÌÉú ÌÜ†Í∏Ä
        async function toggleWordCompletion(word, currentStatus) {
            if (!currentUser) {
                alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }

            try {
                const response = await fetch('/api/words/study/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        word: word,
                        completed: !currentStatus
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ® (ÏôÑÎ£å ÏÉÅÌÉú Î∞òÏòÅ)
                    wordStudyData.words = [];
                    wordStudyData.currentOffset = 0;
                    await loadStudyWords();
                } else {
                    throw new Error(data.message || 'ÏôÑÎ£å ÏÉÅÌÉúÎ•º Î≥ÄÍ≤ΩÌïòÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏôÑÎ£å ÏÉÅÌÉú ÌÜ†Í∏Ä Ïò§Î•ò:', error);
                alert('ÏôÑÎ£å ÏÉÅÌÉúÎ•º Î≥ÄÍ≤ΩÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // Îã®Ïñ¥ Ïπ¥Îìú Î†åÎçîÎßÅ
        function renderWordCards(words, clearFirst = false) {
            const wordCardsList = document.getElementById('wordCardsList');

            if (clearFirst) {
                wordCardsList.innerHTML = '';
            }

            const cardsHTML = words.map((word, index) => {
                const hasDefinition = word.definition && word.definition.trim() !== '';
                const levelInfo = [];
                if (word.min_bt_level) levelInfo.push(`BT ${word.min_bt_level}`);
                if (word.min_lexile) levelInfo.push(`Lexile ${word.min_lexile}`);
                const levelText = levelInfo.length > 0 ? `<span style="color: #667eea; font-size: 0.85rem; font-weight: 500;">üìä ${levelInfo.join(' / ')}</span>` : '';

                // Î≤àÌò∏Îäî ÌòÑÏû¨ÍπåÏßÄ Î°úÎìúÎêú Ï†ÑÏ≤¥ Îã®Ïñ¥ Ïàò Í∏∞Ï§Ä (1Î∂ÄÌÑ∞ ÏãúÏûë)
                const displayNumber = wordStudyData.words.length - words.length + index + 1;

                // ÏôÑÎ£å Ï≤¥ÌÅ¨ Î≤ÑÌäº (Î°úÍ∑∏Ïù∏Ìïú Í≤ΩÏö∞ÏóêÎßå)
                const checkButton = currentUser ? `
                    <button onclick="toggleWordCompletion('${escapeHtml(word.word)}', ${word.is_completed || false})"
                            style="padding: 6px 12px; border-radius: 6px; border: 2px solid ${word.is_completed ? '#26a69a' : '#ddd'}; background: ${word.is_completed ? '#26a69a' : 'white'}; color: ${word.is_completed ? 'white' : '#666'}; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; min-width: 70px;">
                        ${word.is_completed ? '‚úì ÏôÑÎ£å' : 'ÏôÑÎ£å'}
                    </button>
                ` : '';

                return `
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="font-size: 0.9rem; color: #999; font-weight: bold; min-width: 40px;">
                                #${displayNumber}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 1.3rem; font-weight: bold; color: #333; margin-bottom: 5px;">
                                    ${escapeHtml(word.word)}
                                    ${levelText ? `<span style="margin-left: 10px;">${levelText}</span>` : ''}
                                </div>
                                ${hasDefinition ? `
                                    <div style="color: #666; font-size: 0.95rem; line-height: 1.5; margin-top: 8px;">
                                        <strong>Îúª:</strong> ${escapeHtml(word.definition)}
                                    </div>
                                ` : ''}
                                ${word.example_sentence ? `
                                    <div style="color: #888; font-size: 0.9rem; line-height: 1.5; margin-top: 8px; font-style: italic;">
                                        <strong>ÏòàÎ¨∏:</strong> ${escapeHtml(word.example_sentence)}
                                    </div>
                                ` : ''}
                            </div>
                            ${checkButton}
                        </div>
                    </div>
                `;
            }).join('');

            wordCardsList.insertAdjacentHTML('beforeend', cardsHTML);
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
        window.goToWordStudy = goToWordStudy;
        window.changeWordSortBy = changeWordSortBy;
        window.loadMoreWords = loadMoreWords;
        window.changeCompletionFilter = changeCompletionFilter;
        window.toggleWordCompletion = toggleWordCompletion;

        // ===== Îã®Ïñ¥ ÏãúÌóò Í∏∞Îä• =====
        let quizData = {
            quizzes: [],
            currentIndex: 0,
            correctCount: 0,
            answeredCount: 0,
            userAnswers: [],
            wrongQuestions: []
        };

        // Îã®Ïñ¥ ÏãúÌóò ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
        async function goToWordQuiz() {
            try {
                // Î™®Îì† ÏÑπÏÖò Ïà®Í∏∞Í∏∞
                const sections = ['searchSection', 'resultsSection', 'quizSection', 'myPageSection', 'wordStudySection', 'readingNowSection'];
                sections.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.classList.add('hidden');
                });

                document.getElementById('wordQuizSection').classList.remove('hidden');

                // ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî - ÏÑ§Ï†ï ÌôîÎ©¥ÏùÄ Ïà®Í∏∞Í≥† Î∞îÎ°ú ÏãúÏûë
                document.getElementById('quizSetup')?.classList.add('hidden');
                document.getElementById('quizProgress')?.classList.add('hidden');
                document.getElementById('quizResult')?.classList.add('hidden');
                document.getElementById('quizLoading')?.classList.remove('hidden');
                document.getElementById('quizError')?.classList.add('hidden');

                // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                wordQuizData = {
                    quizzes: [],
                    currentIndex: 0,
                    correctCount: 0,
                    answeredCount: 0,
                    userAnswers: [],
                    wrongQuestions: []
                };

                // Í≥µÎ∂ÄÌñàÎçò Î†àÎ≤®Î°ú ÏûêÎèô ÏãúÏûë
                await startQuizWithStudiedLevel();
            } catch (error) {
                console.error('goToWordQuiz error:', error);
                alert('Îã®Ïñ¥ ÏãúÌóò ÌéòÏù¥ÏßÄÎ•º Ïó¨Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // Í≥µÎ∂ÄÌñàÎçò Î†àÎ≤®Î°ú ÏãúÌóò ÏãúÏûë
        async function startQuizWithStudiedLevel() {
            try {
                // Í≥µÎ∂ÄÌñàÎçò Î†àÎ≤®ÏùÑ ÏÇ¨Ïö© (tolerance Ï†ÅÏö©)
                const questionCount = 10; // Í∏∞Î≥∏ 10Î¨∏Ï†ú
                let btLevelMin, btLevelMax;

                if (wordStudyData.sortBy === 'bt_level') {
                    const btLevel = wordStudyData.btLevel;
                    const range = wordStudyData.tolerance * 2; // Îã®Ïñ¥ Í≥µÎ∂ÄÏôÄ ÎèôÏùºÌïú Î≤îÏúÑ ÏÇ¨Ïö©
                    btLevelMin = btLevel;
                    btLevelMax = btLevel + range;
                } else {
                    // LexileÏù∏ Í≤ΩÏö∞ Ìï¥Îãπ LexileÏóê ÎåÄÏùëÌïòÎäî ÎåÄÎûµÏ†ÅÏù∏ BT Level ÏÇ¨Ïö©
                    const lexile = wordStudyData.lexile;
                    // Í∞ÑÎã®Ìïú Îß§Ìïë: Lexile 0-500 -> BT 0-3, 500-1000 -> BT 3-7, 1000+ -> BT 7+
                    const estimatedBT = Math.min(10, lexile / 150);
                    const tolerance = 0.2;
                    btLevelMin = Math.max(0, estimatedBT - tolerance);
                    btLevelMax = estimatedBT + tolerance;
                }

                const quizUrl = `/api/words/quiz?btLevelMin=${btLevelMin}&btLevelMax=${btLevelMax}&count=${questionCount}`;
                console.log('üìù Quiz API Ìò∏Ï∂ú:', quizUrl);
                console.log('üìä ÏöîÏ≤≠ ÌååÎùºÎØ∏ÌÑ∞:', { btLevelMin, btLevelMax, questionCount });

                const response = await fetch(quizUrl);
                const data = await response.json();

                console.log('üì• Quiz API ÏùëÎãµ:', data);

                if (!data.success) {
                    throw new Error(data.message || 'ÏãúÌóò Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }

                // ÏÑúÎ≤Ñ ÏùëÎãµ Íµ¨Ï°∞: { success, data: { quizzes, totalQuestions, btLevelRange } }
                const quizzes = data.data?.quizzes || data.quizzes; // Îëê Í∞ÄÏßÄ Íµ¨Ï°∞ Î™®Îëê ÏßÄÏõê

                if (!quizzes || quizzes.length === 0) {
                    throw new Error('Ìï¥Îãπ Î†àÎ≤®Ïùò Îã®Ïñ¥Í∞Ä Ï∂©Î∂ÑÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                }

                wordQuizData.quizzes = quizzes;
                wordQuizData.currentIndex = 0;

                // Î°úÎî© Ïà®Í∏∞Í≥† ÏãúÌóò ÌôîÎ©¥ ÌëúÏãú
                document.getElementById('quizLoading').classList.add('hidden');
                document.getElementById('quizProgress').classList.remove('hidden');

                // Ï≤´ Î¨∏Ï†ú ÌëúÏãú
                showQuestion();
            } catch (error) {
                console.error('startQuizWithStudiedLevel error:', error);
                document.getElementById('quizLoading').classList.add('hidden');
                document.getElementById('quizError').classList.remove('hidden');
                document.getElementById('quizError').textContent = 'ÏãúÌóò ÏãúÏûë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message;
            }
        }

        // ÏãúÌóò ÏãúÏûë (Íµ¨Î≤ÑÏ†Ñ - ÏÑ§Ï†ï ÌôîÎ©¥ÏóêÏÑú ÏãúÏûëÌï† Îïå ÏÇ¨Ïö©)
        async function startQuiz() {
            const btLevelMin = parseFloat(document.getElementById('btLevelMin').value);
            const btLevelMax = parseFloat(document.getElementById('btLevelMax').value);
            const questionCount = parseInt(document.getElementById('questionCount').value);

            if (btLevelMin > btLevelMax) {
                alert('ÏµúÏÜåÍ∞íÏù¥ ÏµúÎåÄÍ∞íÎ≥¥Îã§ ÌÅ¥ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // ÌôîÎ©¥ Ï†ÑÌôò
            document.getElementById('quizSetup').classList.add('hidden');
            document.getElementById('quizLoading').classList.remove('hidden');

            try {
                const response = await fetch(`/api/words/quiz?btLevelMin=${btLevelMin}&btLevelMax=${btLevelMax}&count=${questionCount}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'ÏãúÌóò Î¨∏Ï†úÎ•º ÏÉùÏÑ±ÌïòÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }

                wordQuizData.quizzes = data.data.quizzes;
                wordQuizData.currentIndex = 0;
                wordQuizData.correctCount = 0;
                wordQuizData.answeredCount = 0;
                wordQuizData.userAnswers = [];
                wordQuizData.wrongQuestions = [];

                // ÏãúÌóò ÏßÑÌñâ ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
                document.getElementById('quizLoading').classList.add('hidden');
                document.getElementById('quizProgress').classList.remove('hidden');

                // Ï≤´ Î¨∏Ï†ú ÌëúÏãú
                showQuestion();

            } catch (error) {
                console.error('ÏãúÌóò ÏÉùÏÑ± Ïò§Î•ò:', error);
                document.getElementById('quizLoading').classList.add('hidden');
                document.getElementById('quizError').textContent = error.message;
                document.getElementById('quizError').classList.remove('hidden');
            }
        }

        // ÏòàÎ¨∏ÏóêÏÑú Ï†ïÎãµ Îã®Ïñ¥Î•º Î∞ëÏ§ÑÎ°ú Î∞îÍæ∏Í∏∞
        function hideAnswerInSentence(sentence, answer) {
            if (!sentence || !answer) return sentence;

            // ÎåÄÏÜåÎ¨∏Ïûê Íµ¨Î∂Ñ ÏóÜÏù¥ Îã®Ïñ¥Ïùò Î™®Îì† ÌòïÌÉúÎ•º Ï∞æÍ∏∞ (Îã®Ïñ¥ Í≤ΩÍ≥Ñ Ìè¨Ìï®)
            // 's, 's, ed, ing Îì±Ïùò Î≥ÄÌòïÎèÑ Í≥†Î†§
            const wordPattern = answer.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // ÌäπÏàòÎ¨∏Ïûê Ïù¥Ïä§ÏºÄÏù¥ÌîÑ
            const regex = new RegExp(`\\b${wordPattern}(s|'s|'s|ed|ing)?\\b`, 'gi');

            // Î∞ëÏ§ÑÎ°ú ÍµêÏ≤¥ (Îã®Ïñ¥ Í∏∏Ïù¥ÎßåÌÅº)
            return sentence.replace(regex, (match) => {
                return '_'.repeat(match.length);
            });
        }

        // Î¨∏Ï†ú ÌëúÏãú
        function showQuestion() {
            const quiz = wordQuizData.quizzes[wordQuizData.currentIndex];
            const questionCard = document.getElementById('quizQuestionCard');

            // ÏßÑÌñâ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('quizProgressText').textContent = `${wordQuizData.currentIndex + 1} / ${wordQuizData.quizzes.length}`;
            document.getElementById('quizScoreText').textContent = `${wordQuizData.correctCount} / ${wordQuizData.answeredCount}`;
            const accuracy = wordQuizData.answeredCount > 0 ? Math.round((wordQuizData.correctCount / wordQuizData.answeredCount) * 100) : 0;
            document.getElementById('quizAccuracyText').textContent = `${accuracy}%`;

            // ÏòàÎ¨∏ÏóêÏÑú Ï†ïÎãµ Îã®Ïñ¥ Ïà®Í∏∞Í∏∞
            const hiddenSentence = hideAnswerInSentence(quiz.exampleSentence, quiz.correctAnswer);

            // Î¨∏Ï†ú Ïπ¥Îìú HTML
            const levelInfo = [];
            if (quiz.btLevel) levelInfo.push(`BT ${quiz.btLevel}`);
            if (quiz.lexile) levelInfo.push(`Lexile ${quiz.lexile}`);
            const levelText = levelInfo.length > 0 ? `<div style="color: #999; font-size: 0.9rem; margin-bottom: 15px;">üìä ${levelInfo.join(' / ')}</div>` : '';

            const choicesHTML = quiz.choices.map((choice, index) => `
                <button onclick="answerQuestion('${escapeHtml(choice.word)}')"
                        class="quiz-choice-btn"
                        data-word="${escapeHtml(choice.word)}"
                        style="width: 100%; padding: 15px; margin: 8px 0; background: white; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; cursor: pointer; text-align: left; transition: all 0.2s;"
                        onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8f9ff';"
                        onmouseout="this.style.borderColor='#ddd'; this.style.background='white';">
                    ${index + 1}. ${escapeHtml(choice.word)}
                </button>
            `).join('');

            questionCard.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">Î¨∏Ï†ú ${quiz.questionNumber}</h3>
                    ${levelText}
                </div>

                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #333;">Îúª:</strong>
                        <div style="color: #666; margin-top: 8px; line-height: 1.6;">${escapeHtml(quiz.definition)}</div>
                    </div>
                    <div>
                        <strong style="color: #333;">ÏòàÎ¨∏:</strong>
                        <div style="color: #666; margin-top: 8px; line-height: 1.6; font-style: italic;">${escapeHtml(hiddenSentence)}</div>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <h4 style="color: #333; margin-bottom: 15px;">ÏúÑ ÎúªÍ≥º ÏòàÎ¨∏Ïóê Ìï¥ÎãπÌïòÎäî Îã®Ïñ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:</h4>
                    ${choicesHTML}
                </div>
            `;
        }

        // ÎãµÏïà ÏÑ†ÌÉù
        function answerQuestion(selectedWord) {
            const quiz = wordQuizData.quizzes[wordQuizData.currentIndex];
            const isCorrect = selectedWord === quiz.correctAnswer;

            // ÎãµÏïà Í∏∞Î°ù
            wordQuizData.userAnswers.push({
                questionNumber: quiz.questionNumber,
                selected: selectedWord,
                correct: quiz.correctAnswer,
                isCorrect: isCorrect,
                quiz: quiz
            });

            wordQuizData.answeredCount++;
            if (isCorrect) {
                wordQuizData.correctCount++;
            } else {
                wordQuizData.wrongQuestions.push(wordQuizData.currentIndex);
            }

            // ÏÑ†ÌÉùÌïú Î≤ÑÌäº ÌïòÏù¥ÎùºÏù¥Ìä∏
            const buttons = document.querySelectorAll('.quiz-choice-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'not-allowed';
                const word = btn.getAttribute('data-word');

                if (word === quiz.correctAnswer) {
                    btn.style.borderColor = '#26a69a';
                    btn.style.background = '#e8f5e9';
                    btn.style.fontWeight = 'bold';
                } else if (word === selectedWord && !isCorrect) {
                    btn.style.borderColor = '#f5576c';
                    btn.style.background = '#ffebee';
                }
            });

            // 1.5Ï¥à ÌõÑ Îã§Ïùå Î¨∏Ï†úÎ°ú
            setTimeout(() => {
                wordQuizData.currentIndex++;

                if (wordQuizData.currentIndex < wordQuizData.quizzes.length) {
                    showQuestion();
                } else {
                    showResult();
                }
            }, 1500);
        }

        // Í≤∞Í≥º ÌëúÏãú
        function showResult() {
            document.getElementById('quizProgress').classList.add('hidden');
            document.getElementById('quizResult').classList.remove('hidden');

            const totalQuestions = wordQuizData.quizzes.length;
            const correctCount = wordQuizData.correctCount;
            const accuracy = Math.round((correctCount / totalQuestions) * 100);

            document.getElementById('finalScore').textContent = `${correctCount} / ${totalQuestions}`;
            document.getElementById('finalAccuracy').textContent = `Ï†ïÎãµÎ•†: ${accuracy}%`;

            // ÌãÄÎ¶∞ Î¨∏Ï†ú ÌëúÏãú
            const wrongAnswersList = document.getElementById('wrongAnswersList');
            if (wordQuizData.wrongQuestions.length > 0) {
                const wrongHTML = wordQuizData.wrongQuestions.map(idx => {
                    const answer = wordQuizData.userAnswers.find(a => a.questionNumber === wordQuizData.quizzes[idx].questionNumber);
                    const quiz = answer.quiz;

                    return `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f5576c;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 10px;">Î¨∏Ï†ú ${quiz.questionNumber}</div>
                            <div style="color: #666; margin-bottom: 8px;"><strong>Îúª:</strong> ${escapeHtml(quiz.definition)}</div>
                            <div style="color: #f5576c; margin-bottom: 5px;">‚ùå ÏÑ†ÌÉù: <strong>${escapeHtml(answer.selected)}</strong></div>
                            <div style="color: #26a69a;">‚úÖ Ï†ïÎãµ: <strong>${escapeHtml(quiz.correctAnswer)}</strong></div>
                        </div>
                    `;
                }).join('');

                wrongAnswersList.innerHTML = `
                    <h3 style="color: #333; margin-bottom: 15px;">ÌãÄÎ¶∞ Î¨∏Ï†ú (${wordQuizData.wrongQuestions.length}Í∞ú)</h3>
                    ${wrongHTML}
                `;
            } else {
                wrongAnswersList.innerHTML = `
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; text-align: center; color: #26a69a; font-size: 1.2rem;">
                        üéâ ÏôÑÎ≤ΩÌï©ÎãàÎã§! Î™®Îì† Î¨∏Ï†úÎ•º ÎßûÏ∑ÑÏäµÎãàÎã§!
                    </div>
                `;
            }
        }

        // ÌãÄÎ¶∞ Î¨∏Ï†ú Îã§Ïãú ÌíÄÍ∏∞
        async function retryWrongAnswers() {
            if (wordQuizData.wrongQuestions.length === 0) {
                alert('ÌãÄÎ¶∞ Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§!');
                return;
            }

            // ÌãÄÎ¶∞ Î¨∏Ï†úÎßå Ï∂îÏ∂ú
            const wrongQuizzes = wordQuizData.wrongQuestions.map(idx => wordQuizData.quizzes[idx]);

            // ÏÉàÎ°úÏö¥ ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
            quizData = {
                quizzes: wrongQuizzes,
                currentIndex: 0,
                correctCount: 0,
                answeredCount: 0,
                userAnswers: [],
                wrongQuestions: []
            };

            // ÏãúÌóò ÏßÑÌñâ ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
            document.getElementById('quizResult').classList.add('hidden');
            document.getElementById('quizProgress').classList.remove('hidden');

            // Ï≤´ Î¨∏Ï†ú ÌëúÏãú
            showQuestion();
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
        window.goToWordQuiz = goToWordQuiz;
        window.startQuiz = startQuiz;
        window.answerQuestion = answerQuestion;
        window.retryWrongAnswers = retryWrongAnswers;
    </script>

    <!-- Îã®Ïñ¥ Î™®Îã¨ -->
    <!-- Ïä¨ÎùºÏù¥Îìú Ìå®ÎÑê Ïò§Î≤ÑÎ†àÏù¥ -->
    <div id="slidePanelOverlay" class="slide-panel-overlay" onclick="closeSlidePanel()"></div>

    <!-- Îã®Ïñ¥ Ïä¨ÎùºÏù¥Îìú Ìå®ÎÑê -->
    <div id="wordsPanel" class="slide-panel">
        <div class="slide-panel-header">
            <div class="slide-panel-header-content">
                <div>
                    <h2 class="slide-panel-title">üìö Îã®Ïñ¥ Î™©Î°ù</h2>
                    <p class="slide-panel-subtitle" id="wordsPanelSubtitle"></p>
                </div>
                <button class="slide-panel-close" onclick="closeSlidePanel()">&times;</button>
            </div>
        </div>
        <div class="slide-panel-body">
            <div id="wordsLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Îã®Ïñ¥ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
            </div>
            <div id="wordsError" class="error-message" style="display: none;"></div>
            <div id="wordsContent"></div>
        </div>
    </div>

    <!-- ÌÄ¥Ï¶à Î™®Îã¨ -->
    <div id="quizModalOverlay" class="quiz-modal-overlay" onclick="closeQuizModal(event)">
        <div class="quiz-modal" onclick="event.stopPropagation()">
            <div class="quiz-modal-header">
                <div>
                    <h2 class="quiz-modal-title">üìù ÌÄ¥Ï¶à Î™©Î°ù</h2>
                    <p class="quiz-modal-subtitle" id="quizModalSubtitle"></p>
                </div>
                <button class="quiz-modal-close" onclick="closeQuizModal()">&times;</button>
            </div>
            <div class="quiz-modal-body">
                <div id="quizLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>ÌÄ¥Ï¶à Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                </div>
                <div id="quizError" class="error-message" style="display: none;"></div>
                <div id="quizContent"></div>
            </div>
        </div>
    </div>
</body>
</html>
